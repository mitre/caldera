<div x-data="alpineSources()" x-init="getSources()" id="sourcePage">
    <div>
        <h2>Fact Sources</h2>
        <p>
            Facts are identifiable pieces of data, collected by agents or loaded when the server starts.
            A source is a collection of facts. Rules are boundaries to ensure specific traits cannot be used.
        </p>
    </div>
    <hr>
    <div>

        <!-- FACT SELECTION -->

        <form>
            <div id="select-source" class="field has-addons">
                <label class="label">Select a source &nbsp;&nbsp;&nbsp;</label>
                <div class="control is-expanded">
                    <div class="select is-small is-fullwidth">
                        <select x-on:change="handleSelectSource()" x-model="selectedSourceId">
                            <option value="" default disabled selected>Select a source...</option>
                            <template x-for="source of sources" :key="source.id">
                                <option x-bind:value="source.id" x-text="source.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="control">
                    <button type="button" class="button is-primary is-small" @click="createSource()">+ Create Source
                    </button>
                </div>
            </div>
        </form>

        <!-- CONTENT -->

        <template x-if="!selectedSourceId">
            <p class="is-flex is-justify-content-center is-italic mt-2">Select a fact source to get started.</p>
        </template>

        <template x-if="selectedSourceId">
            <div class="section">
                <div x-show="!isEditingSourceName">
                    <h3 x-text="selectedSource.name" class="pointer tooltip has-tooltip-arrow"
                        data-tooltip="Click to edit" @click="isEditingSourceName = true"></h3>
                </div>
                <form x-show="isEditingSourceName">
                    <div class="field">
                        <div class="control">
                            <label x-show="false" class="label">Source Name</label>
                            <input id="sourceName" class="input" placeholder="Enter a source name"
                                   x-model="selectedSource.name">
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            <button class="button is-small is-primary" @click="saveSourceName()">
                                <span class="icon"><em class="fas fa-save"></em></span>
                                <span>Save</span>
                            </button>
                            <button class="button is-small" @click="isEditingSourceName = false">Cancel</button>
                        </div>
                    </div>
                </form>
                <div class="control-buttons is-flex is-flex-direction-row">
                    <button class="button is-small mr-2"
                            @click="openModal = { isOpen: true, name: 'Add From Ability' }; filterAbilities()">
                        <span class="icon"><em class="fas fa-plus"></em></span>
                        <span>Add Facts from Ability</span>
                    </button>
                    <button class="button is-small mr-2"
                            @click="openModal = { isOpen: true, name: 'Add From Adversary' }; getAdversaries();">
                        <span class="icon"><em class="fas fa-user-plus"></em></span>
                        <span>Add Facts from Adversary</span>
                    </button>
                    <button class="button is-small mr-2" @click="duplicateSource(selectedSource)">
                        <span class="icon"><em class="fas fa-copy"></em></span>
                        <span>Duplicate Source</span>
                    </button>
                    <div class="vr"></div>
                    <button class="button is-small mr-2 is-danger is-outlined"
                            @click="openModal = { isOpen: true, name: 'Delete Source' }">
                        <span class="icon"><em class="fas fa-trash"></em></span>
                        <span>Delete Source</span>
                    </button>
                </div>

                <!-- FACTS -->
                <div x-data="{collapseFacts: false}">
                    <div class="collapsible-header mt-3 mb-1">
                        <button class="button px-0 no-style is-size-5" x-on:click="collapseFacts = !collapseFacts"
                                x-bind:class="collapseFacts ? 'collapsed' : 'expanded'">
                            <span x-text="`Facts (${filteredFacts.length})`"></span>
                        </button>
                    </div>
                    <div x-show="!collapseFacts">
                        <div class="is-flex is-flex-direction-row mb-3">
                            <button type="button" class="button is-small mr-2"
                                    x-on:click="showAddFactRow = true; selectedFactIndex = -1"
                                    x-bind:disabled="showAddFactRow">
                                <span class="icon"><i class="fas fa-plus"></i></span>
                                <span>Add Fact</span>
                            </button>
                            <div class="field mr-2">
                                <p class="control has-icons-left">
                                    <input class="input is-small"
                                           id="fact-search"
                                           placeholder="Find a fact..."
                                           x-on:keyup="filterFacts($el.value)">
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </p>
                            </div>
                        </div>

                        <table class="table is-striped is-fullwidth">
                            <colgroup>
                                <col width="15%">
                                <col width="30%">
                                <col width="30%">
                                <col width="10%">
                                <col width="15%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th @click="sortTable('origin', filteredFacts, 'facts')"
                                    class="has-text-left is-clickable">Origin <em class="fas fa-sort pr-2"></em></th>
                                <th @click="sortTable('trait', filteredFacts, 'facts')"
                                    class="has-text-left is-clickable">Fact Trait <em class="fas fa-sort pr-2"></em>
                                </th>
                                <th @click="sortTable('value', filteredFacts, 'facts')"
                                    class="has-text-left is-clickable">Value <em class="fas fa-sort pr-2"></em></th>
                                <th @click="sortTable('score', filteredFacts, 'facts')"
                                    class="has-text-left is-clickable">Score <em class="fas fa-sort pr-2"></em></th>
                                <th class="has-text-left"></th>
                            </tr>
                            </thead>
                            <tbody x-show="filteredFacts.length === 0 && !showAddFactRow">
                            <tr>
                                <td class="is-italic text-align-center" colspan="6">No facts in this source.</td>
                            </tr>
                            </tbody>
                            <tbody x-show="filteredFacts.length > 0 || showAddFactRow"
                                   @click.outside="selectedFactIndex = -1; factIndexToDelete = -1">
                            <tr x-data="{ newFact: EMPTY_FACT_OBJECT }" x-show="showAddFactRow">
                                <td></td>
                                <td>
                                    <input id="new-fact-trait" class="input is-small" x-model="newFact.trait"
                                           contenteditable>
                                </td>
                                <td>
                                    <input id="new-fact-value" class="input is-small" x-model="newFact.value"
                                           contenteditable>
                                </td>
                                <td>
                                    <input class="is-small input fact-score" id="new-fact-score" type="number"
                                           x-model="newFact.score" min="0"/>
                                </td>
                                <td>
                                    <button type="button"
                                            class="button is-small is-primary mb-1"
                                            x-on:click="addFact(newFact); newFact = EMPTY_FACT_OBJECT">
                                        Add
                                    </button>
                                    <button type="button"
                                            class="button is-small"
                                            x-on:click="showAddFactRow = false; newFact = EMPTY_FACT_OBJECT">
                                        Cancel
                                    </button>
                                </td>
                            </tr>
                            <template x-for="(fact, index) in filteredFacts" :key="index">
                                <tr x-on:click="selectedFactIndex = index; showAddFactRow = false;"
                                    x-bind:class="selectedFactIndex === index ? 'selected' : ''">
                                    <td>
                                        <span class="tag"
                                              x-bind:class="(fact.origin_type) ? 'origin-' + fact.origin_type : ''"
                                              x-text="fact.origin_type"></span>
                                    </td>
                                    <td x-show="selectedFactIndex !== index">
                                        <span class="tag is-dark" x-text="fact.trait"></span>
                                    </td>
                                    <td x-show="selectedFactIndex === index">
                                        <input id="edit-fact-trait" class="input is-small" x-model="fact.trait"
                                               contenteditable>
                                    </td>

                                    <td x-show="selectedFactIndex !== index" class="is-italic"
                                        x-text="fact.value"></span>
                                    </td>
                                    <td x-show="selectedFactIndex === index">
                                        <input id="edit-fact-value" class="input is-small" x-model="fact.value"
                                               contenteditable>
                                    </td>

                                    <td x-text="fact.score"></td>

                                    <td class="has-text-right"
                                        x-show="selectedFactIndex !== index && factIndexToDelete !== index">
                                        <button class="delete is-danger"
                                                @click.stop="factIndexToDelete = index"></button>
                                    </td>

                                    <td class="has-text-right"
                                        x-show="factIndexToDelete === -1 && selectedFactIndex === index">
                                        <button type="button"
                                                class="button is-small is-primary"
                                                x-on:click.stop="updateFactSource()">
                                                <span class="icon">
                                                    <em class="fas fa-save"></em>
                                                </span>
                                            <span>Save</span>
                                        </button>
                                        <button type="button"
                                                class="button is-small"
                                                x-on:click.stop="selectedFactIndex = -1; getSources();">
                                            Cancel
                                        </button>
                                    </td>

                                    <td class="has-text-right" x-show="factIndexToDelete === index">
                                        <div class="is-flex is-justify-content-end">
                                            <p class="m-1 mr-3">Delete</p>
                                            <button type="button" class="button is-small is-danger mr-2"
                                                    x-on:click.stop="deleteFact(factIndexToDelete)">
                                                Delete Fact
                                            </button>
                                            <button type="button" class="button is-small"
                                                    x-on:click.stop="factIndexToDelete = -1; selectedFactIndex = -1">
                                                Cancel
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- RULES -->
                <div x-data="{collapseRules: false}">
                    <div class="collapsible-header mt-3 mb-1">
                        <button class="button px-0 no-style is-size-5" x-on:click="collapseRules = !collapseRules"
                                x-bind:class="collapseRules ? 'collapsed' : 'expanded'">
                            <span x-text="`Rules (${filteredRules.length})`"></span>
                        </button>
                    </div>
                    <div x-show="!collapseRules">
                        <div class="is-flex is-flex-direction-row mb-3">
                            <button type="button"
                                    class="button is-small mr-2"
                                    x-on:click="showAddRuleRow = true; selectedRuleIndex = -1"
                                    x-bind:disabled="showAddRuleRow">
                                <span class="icon"><i class="fas fa-plus"></i></span>
                                <span>Add Rule</span>
                            </button>
                            <div class="field mr-2"
                                 x-show="selectedSource.rules">
                                <p class="control has-icons-left">
                                    <input class="input is-small"
                                           id="rule-search"
                                           placeholder="Find a rule..."
                                           x-on:keyup="filterRules($el.value)">
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </p>
                            </div>
                        </div>

                        <!-- RULES TABLE -->
                        <table class="table is-striped is-fullwidth" x-show="filteredRules">
                            <colgroup>
                                <col width="15%">
                                <col width="30%">
                                <col width="40%">
                                <col width="15%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th @click="sortTable('match', filteredRules, 'rules')"
                                    class="has-text-left is-clickable">Match <em class="fas fa-sort pr-2"></em></th>
                                <th @click="sortTable('trait', filteredRules, 'rules')"
                                    class="has-text-left is-clickable">Fact Trait <em class="fas fa-sort pr-2"></em>
                                </th>
                                <th @click="sortTable('action', filteredRules, 'rules')"
                                    class="text-align-center is-clickable">Action <em class="fas fa-sort pr-2"></em>
                                </th>
                                <th class="has-text-left"></th>
                            </tr>
                            </thead>
                            <tbody x-show="filteredRules.length === 0 && !showAddRuleRow">
                            <tr>
                                <td class="is-italic text-align-center" colspan="6">No rules in this source.</td>
                            </tr>
                            </tbody>
                            <tbody x-show="filteredRules.length > 0 || showAddRuleRow"
                                   @click.outside="selectedRuleIndex = -1; ruleIndexToDelete = -1">
                            <template x-if="showAddRuleRow">
                                <tr x-data="{newRule: EMPTY_RULE_OBJECT}">
                                    <td>
                                        <input id="new-rule-match" class="input is-small" x-model="newRule.match"
                                               contenteditable>
                                    </td>
                                    <td>
                                        <input id="new-rule-trait" class="input is-small" x-model="newRule.trait"
                                               contenteditable>
                                    </td>
                                    <td>
                                        <div class="toggleContainer is-flex is-justify-content-center"
                                             id="new-rule-action">
                                            <label class="has-text-danger" for="toggleAction">DENY</label>
                                            <div class="toggleSwitch mx-2">
                                                <input type="checkbox"
                                                       id="toggleAction"
                                                       x-model="newRule.action"
                                                       x-bind:checked="newRule.action === 'ALLOW' ? 'checked' : null"/>
                                                <span class="toggleSlider toggleSliderRound"
                                                      x-on:click="newRule.action = (newRule.action === 'ALLOW' ? 'DENY' : 'ALLOW')"
                                                      x-bind:class="newRule.action === 'ALLOW' ? 'toggle-on' : 'toggle-off'">
                                                        <span x-bind:class="newRule.action === 'ALLOW' ? 'toggle-slider-on' : 'toggle-slider-off'"></span>
                                                    </span>
                                                </div>
                                                <label class="has-text-success" for="toggleAction">ALLOW</label>
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button"
                                                    class="button is-small is-primary"
                                                    x-on:click="addRule(newRule); newRule = EMPTY_RULE_OBJECT">
                                                Add
                                            </button>
                                            <button type="button"
                                                    class="button is-small"
                                                    x-on:click="showAddRuleRow = false; newRule = EMPTY_RULE_OBJECT">
                                                Cancel
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                <template x-for="(rule, index) in filteredRules">
                                    <tr x-on:click="selectedRuleIndex = index; showAddRuleRow = false;" x-bind:class="selectedRuleIndex === rule ? 'selected' : ''">
                                        <td x-text="index + 1"></td>

                                        <td x-show="selectedRuleIndex === index">
                                            <input id="edit-rule-match" class="input is-small" x-model="rule.match" contenteditable>
                                        </td>
                                        <td x-show="selectedRuleIndex !== index" class="is-italic" x-text="rule.match"></td>
                                            </div>
                                            <label class="has-text-success" for="toggleAction">ALLOW</label>
                                        </div>
                                    </td>
                                    <td>
                                        <button type="button"
                                                class="button is-small is-primary mb-1"
                                                x-on:click="addRule(newRule); newRule = EMPTY_RULE_OBJECT">
                                            Add
                                        </button>
                                        <button type="button"
                                                class="button is-small"
                                                x-on:click="showAddRuleRow = false; newRule = EMPTY_RULE_OBJECT">
                                            Cancel
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <template x-for="(rule, index) in filteredRules">
                                <tr x-on:click="selectedRuleIndex = index; showAddRuleRow = false;"
                                    x-bind:class="selectedRuleIndex === rule ? 'selected' : ''">
                                    <td x-show="selectedRuleIndex === index">
                                        <input id="edit-rule-match" class="input is-small" x-model="rule.match"
                                               contenteditable>
                                    </td>
                                    <td x-show="selectedRuleIndex !== index" class="is-italic" x-text="rule.match"></td>

                                    <td x-show="selectedRuleIndex === index">
                                        <input id="edit-rule-trait" class="input is-small" x-model="rule.trait"
                                               contenteditable>
                                    </td>
                                    <td x-show="selectedRuleIndex !== index">
                                        <span class="tag is-dark" x-text="rule.trait"></span>
                                    </td>

                                    <td x-show="selectedRuleIndex === index">
                                        <div class="toggleContainer is-flex is-justify-content-center">
                                            <label for="toggleRuleAction"><span
                                                    class="tag is-danger">DENY</span></label>
                                            <div class="toggleSwitch mx-2">
                                                <input type="checkbox"
                                                       id="toggleRuleAction"
                                                       x-model="rule.action"
                                                       x-bind:checked="rule.action === 'ALLOW' ? 'checked' : null"/>
                                                <span class="toggleSlider toggleSliderRound"
                                                      x-on:click="rule.action = (rule.action === 'ALLOW' ? 'DENY' : 'ALLOW')"
                                                      x-bind:class="rule.action === 'ALLOW' ? 'toggle-on' : 'toggle-off'">
                                                        <span x-bind:class="rule.action === 'ALLOW' ? 'toggle-slider-on' : 'toggle-slider-off'"></span>
                                                    </span>
                                            </div>
                                            <label class="has-text-success" for="toggleAction"><span
                                                    class="tag is-success">ALLOW</span></label>
                                        </div>
                                    </td>
                                    <td x-show="selectedRuleIndex !== index" class="text-align-center">
                                            <span class="tag"
                                                  x-bind:class="rule.action === 'ALLOW' ? 'is-success' : 'is-danger'"
                                                  x-text="rule.action"></span>
                                    </td>

                                    <td class="has-text-right"
                                        x-show="selectedRuleIndex !== index && ruleIndexToDelete !== index">
                                        <button class="delete is-danger"
                                                @click.stop="ruleIndexToDelete = index"></button>
                                    </td>

                                    <td class="has-text-right"
                                        x-show="ruleIndexToDelete === -1 && selectedRuleIndex === index">
                                        <button type="button"
                                                class="button is-small is-primary"
                                                x-on:click.stop="updateFactSource()">
                                                <span class="icon">
                                                    <em class="fas fa-save"></em>
                                                </span>
                                            <span>Save</span>
                                        </button>
                                        <button type="button"
                                                class="button is-small"
                                                x-on:click.stop="selectedRuleIndex = -1; getSources();">
                                            Cancel
                                        </button>
                                    </td>

                                    <td class="has-text-right" x-show="ruleIndexToDelete === index">
                                        <div class="is-flex is-justify-content-end">
                                            <p class="m-1 mr-3"></p>
                                            <button type="button" class="button is-small is-danger mr-2"
                                                    x-on:click.stop="deleteRule(ruleIndexToDelete)">
                                                Delete Rule
                                            </button>
                                            <button type="button" class="button is-small"
                                                    x-on:click.stop="ruleIndexToDelete = -1; selectedRuleIndex = -1">
                                                Cancel
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- RELATIONSHIPS -->
                <div x-data="{collapseRelationships: false}">
                    <div class="collapsible-header mt-3 mb-1">
                        <button class="button px-0 no-style is-size-5"
                                x-on:click="collapseRelationships = !collapseRelationships"
                                x-bind:class="collapseRelationships ? 'collapsed' : 'expanded'">
                            <span x-text="`Relationships (${selectedSource.relationships.length})`"></span>
                        </button>
                    </div>
                    <div x-show="!collapseRelationships" x-data="{selectedRelationshipIndex: -1}">
                        <div class="is-flex is-flex-direction-row mb-3">
                            <div class="pl-0 is-flex is-align-content-flex-start">
                                <button type="button"
                                        class="button is-small mr-2"
                                        x-on:click="showAddRelationshipRow = true; selectedRelationshipIndex = -1"
                                        x-bind:disabled="showAddRelationshipRow">
                                    <span class="icon"><i class="fas fa-plus"></i></span>
                                    <span>Add Relationship</span>
                                </button>
                                <div class="field mr-2">
                                    <p class="control has-icons-left">
                                        <input class="input is-small"
                                               id="relationship-search"
                                               placeholder="Find a relationship..."
                                               x-on:keyup="filterRelationships($el.value)">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-search"></i>
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- RELATIONSHIPS TABLE -->
                        <table class="table is-striped is-fullwidth">
                            <colgroup>
                                <col width="25%">
                                <col width="30%">
                                <col width="30%">
                                <col width="15%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th @click="sortTable('source', filteredRelationships, 'relationships')"
                                    class="has-text-left is-clickable">Source <em class="fas fa-sort pr-2"></em></th>
                                <th @click="sortTable('edge', filteredRelationships, 'relationships')"
                                    class="has-text-left is-clickable">Edge <em class="fas fa-sort pr-2"></em></th>
                                <th @click="sortTable('target', filteredRelationships, 'relationships')"
                                    class="has-text-left is-clickable">Target <em class="fas fa-sort pr-2"></em></th>
                                <th class="has-text-left"></th>
                            </tr>
                            </thead>
                            <tbody x-show="filteredRelationships.length === 0 && !showAddRelationshipRow">
                            <tr>
                                <td class="is-italic text-align-center" colspan="6">No relationships in this source.
                                </td>
                            </tr>
                            </tbody>
                            <tbody x-show="filteredRelationships.length > 0 || showAddRelationshipRow"
                                   @click.outside="selectedRelationshipIndex = -1; relationshipIndexToDelete = -1">
                            <tr x-show="showAddRelationshipRow">
                                <td>
                                    <input id="new-relationship-source" class="input is-small"
                                           x-model="newRelationship.sourceTrait" contenteditable>
                                </td>
                                <td>
                                    <input id="new-relationship-edge" class="input is-small"
                                           x-model="newRelationship.edge" contenteditable>
                                </td>
                                <td>
                                    <input id="new-relationship-target" class="input is-small"
                                           x-model="newRelationship.targetTrait" contenteditable>
                                </td>
                                <td>
                                    <button type="button"
                                            class="button is-small is-primary"
                                            x-on:click.stop="addRelationship(newRelationship)">
                                        Add
                                    </button>
                                    <button type="button"
                                            class="button is-small"
                                            x-on:click.stop="showAddRelationshipRow = false">
                                        Cancel
                                    </button>
                                </td>
                            </tr>
                            <template x-for="(rel, index) in filteredRelationships">
                                <tr x-on:click="selectedRelationshipIndex = index; showAddRelationshipRow = false;"
                                    x-bind:class="selectedRelationshipIndex === index ? 'selected' : ''">
                                    <td x-show="selectedRelationshipIndex !== index" x-text="rel.source?.trait"></td>
                                    <td x-show="selectedRelationshipIndex === index">
                                        <input id="edit-rel-trait" class="input is-small" x-model="rel.source.trait"
                                               contenteditable>
                                    </td>

                                    <td x-show="selectedRelationshipIndex !== index" x-text="rel.edge"></td>
                                    <td x-show="selectedRelationshipIndex === index">
                                        <input id="edit-rel-trait" class="input is-small" x-model="rel.edge"
                                               contenteditable>
                                    </td>

                                    <td x-show="selectedRelationshipIndex !== index" x-text="rel.target?.trait"></td>
                                    <td x-show="selectedRelationshipIndex === index">
                                        <input id="edit-rel-trait" class="input is-small" x-model="rel.target.trait"
                                               contenteditable>
                                    </td>

                                    <td class="has-text-right"
                                        x-show="selectedRelationshipIndex !== index && relationshipIndexToDelete !== index">
                                        <button class="delete is-danger"
                                                @click.stop="relationshipIndexToDelete = index"></button>
                                    </td>

                                    <td class="has-text-right"
                                        x-show="relationshipIndexToDelete === -1 && selectedRelationshipIndex === index">
                                        <button type="button"
                                                class="button is-small is-primary"
                                                x-on:click.stop="updateFactSource()">
                                                <span class="icon">
                                                    <em class="fas fa-save"></em>
                                                </span>
                                            <span>Save</span>
                                        </button>
                                        <button type="button"
                                                class="button is-small"
                                                x-on:click.stop="selectedRelationshipIndex = -1; getSources();">
                                            Cancel
                                        </button>
                                    </td>

                                    <td class="has-text-right" x-show="relationshipIndexToDelete === index">
                                        <div class="is-flex is-justify-content-end">
                                            <button type="button" class="button is-small is-danger mr-2"
                                                    x-on:click.stop="deleteRelationship(relationshipIndexToDelete)">
                                                Delete Relationship
                                            </button>
                                            <button type="button" class="button is-small"
                                                    x-on:click.stop="relationshipIndexToDelete = -1; selectedRelationshipIndex = -1">
                                                Cancel
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <div class="modal" x-bind:class="{ 'is-active': openModal.isOpen }">
        <div class="modal-background" @click="openModal.isOpen = false"></div>
        <template x-if="openModal.name.includes('Delete')">
            <div class="modal-card" style="z-index: 20">
                <header class="modal-card-head">
                    <p class="modal-card-title">Delete Fact Source?</p>
                </header>
                <section class="modal-card-body">
                    <p>
                        Are you sure you want to delete this fact source? This cannot be undone.
                    </p>
                </section>
                <footer class="modal-card-foot">
                    <nav class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <button class="button is-small" @click="openModal.isOpen = false">Cancel</button>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button class="button is-danger is-small"
                                        @click="deleteSource(); openModal.isOpen = false;">
                                    <span class="icon"><em class="fas fa-trash"></em></span>
                                    <span class="has-text-weight-bold">Delete Source</span>
                                </button>
                                <div>
                                </div>
                    </nav>
                </footer>
            </div>
        </template>
        <template x-if="openModal.name.includes('Ability')" x-data="{selectedAbility: null}">
            <div class="modal-card" style="z-index: 20">
                <header class="modal-card-head">
                    <p class="modal-card-title">Add Fact from Ability </p>
                </header>
                <section class="modal-card-body">
                    <form>
                        <div class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label"><span class="icon is-small"><em class="fas fa-search"></em></span></label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <div class="control">
                                        <input class="input is-small" x-model="abilitySearch.query"
                                               placeholder="Search for an ability..." x-on:keyup="filterAbilities()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label">Tactic</label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select id="link-tactic" x-model="abilitySearch.tactic"
                                                    x-on:change="filterAbilities()">
                                                <option default value="">All tactics</option>
                                                <template x-for="tactic in tactics" :key="tactic">
                                                    <option x-text="tactic"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label">Technique</label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select id="link-technique" x-model="abilitySearch.technique"
                                                    x-on:change="filterAbilities()">
                                                <option default value="">All techniques</option>
                                                <template x-for="technique in techniques" :key="technique">
                                                    <option x-text="technique"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <hr>
                    <div class="is-flex is-justify-content-space-between mb-2">
                        <strong x-show="filteredAbilities.length">Select an ability</strong>
                    </div>
                    <template x-for="ability in filteredAbilities" :key="ability.ability_id">
                        <div class="box selectable mb-2 mr-2 p-3 has-background-black-ter"
                             x-bind:class="{'selected': selectedAbility === ability}"
                             @click="selectedAbility = ability">
                            <p class="mb-0">
                                <span class="has-text-weight-bold" x-text="ability.name"></span>
                                <span x-text="`${ability.technique_id}`"></span>
                            </p>
                            <div class="is-flex is-align-items-center">
                                <label class="is-italic is-size-7" for="ability-fact-score">Score: </label>
                                <input class="input has-background-grey-darker is-small m-2 w-50-px"
                                       id="ability-fact-score" x-model="ability.score" type="number" required
                                       pattern="[0-9]*" min="0" placeholder="1"/>
                            </div>
                            <p x-show="ability.factTraits" class="is-italic is-size-7">
                                <span>Facts: </span>
                                <template x-for="fact in ability.factTraits">
                                    <span class="has-background-warning has-text-black mr-2 px-1"
                                          x-text="`${fact}`"></span>
                                </template>
                            </p>
                            <p class="is-size-7" x-text="ability.description"></p>
                        </div>
                    </template>
                    <template x-if="filteredAbilities.length === 0">
                        <p class="is-size-7 is-italic ml-4 text-align-center">No results, try
                            <button class="no-style button-link is-italic has-text-white is-size-7 px-0"
                                    alt="click to reset search" @click="resetSearch()">
                                resetting search
                            </button>
                            ?
                        </p>
                    </template>
                </section>
                <footer class="modal-card-foot">
                    <nav class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <button class="button is-small" @click="openModal.isOpen = false">Done</button>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button x-bind:disabled="!selectedAbility" class="button is-primary is-small"
                                        @click="addFromAbility(selectedAbility.factTraits, selectedAbility.score); openModal.isOpen = false">
                                    <span>Add Facts</span>
                                </button>
                                <div>
                                </div>
                    </nav>
                </footer>
            </div>
        </template>
        <template x-if="openModal.name.includes('Adversary')" x-data="{selectedAdversary: ''}">
            <div class="modal-card" style="z-index: 20">
                <header class="modal-card-head">
                    <p class="modal-card-title">Add Fact from Adversary</p>
                </header>
                <section class="modal-card-body">
                    <form>
                        <div class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label" for="sourcesAdversaryDropdown">Adversary</label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select id="sourcesAdversaryDropdown"
                                                    x-on:change="filteredAbilities = []; getAdversaryFacts(selectedAdversary)"
                                                    x-model="selectedAdversary">
                                                <option value="" default disabled selected>Select one...</option>
                                                <template x-for="adversary of adversaries"
                                                          :key="adversary.adversary_id">
                                                    <option x-bind:value="adversary.adversary_id"
                                                            x-text="adversary.name"
                                                            x-bind:title="adversary.description"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <template x-if="selectedAdversary">
                        <span>
                            <hr>
                            <div class="is-flex is-justify-content-space-between mb-2">
                                <strong x-show="selectedAdversary" x-text="'Adversary Abilities'"></strong>
                            </div>
                            <template x-if="filteredAbilities.length < 1">
                                <div class="box mb-2 mr-2 p-3 has-background-black-ter">
                                    <p class="text-align-center is-italic">This adversary has no facts available.</p>
                                </div>
                            </template>
                            <template x-if="filteredAbilities.length > 0">
                                <span>
                                    <template x-for="(ability, index) in filteredAbilities" :key="index">
                                        <div class="box mb-2 mr-2 p-3 has-background-black-ter">
                                            <p>
                                                <span class="has-text-weight-bold" x-text="ability.name"></span>
                                                <span x-text="`${ability.technique_id}`"></span>
                                            </p>
                                            <div class="is-flex is-align-items-center">
                                                <label class="is-italic is-size-7"
                                                       for="adversary-fact-score">Score: </label>
                                                <input class="input has-background-grey-darker is-small m-2 w-50-px"
                                                       id="adversary-fact-score" x-model="ability.score" type="number"
                                                       required pattern="[0-9]*" min="0" placeholder="1"/>
                                            </div>
                                            <p x-show="ability.factTraits" class="is-italic is-size-7">
                                                <span>Facts: </span>
                                                <template x-for="fact in ability.factTraits">
                                                    <span class="has-background-warning has-text-black mr-2 px-1"
                                                          x-text="`${fact}`"></span>
                                                </template>
                                            </p>
                                            <p class="is-size-7" x-text="ability.description"></p>
                                        </div>
                                    </template>
                                </span>
                            </template>
                        </span>
                    </template>
                </section>
                <footer class="modal-card-foot">
                    <nav class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <button class="button is-small" @click="openModal.isOpen = false">Done</button>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button x-bind:disabled="filteredAbilities.length < 1"
                                        class="button is-primary is-small"
                                        @click="addFromAdversary(); openModal.isOpen = false">
                                    <span>Add All Facts</span>
                                </button>
                                <div>
                                </div>
                    </nav>
                </footer>
            </div>
        </template>
    </div>

</div>

<script>
    function alpineSources() {
        return {
            // CONSTANTS
            EMPTY_FACT_OBJECT: {
                trait: '',
                value: '',
                score: 1
            },
            EMPTY_RULE_OBJECT: {
                action: 'ALLOW',
                match: '',
                trait: ''
            },

            sources: [],
            filteredSources: [],
            filteredFacts: [],
            filteredRules: [],
            filteredRelationships: [],

            selectedSource: {
                name: '',
                relationships: []
            },
            selectedSourceId: '',
            selectedRelationshipIndex: null,
            selectedFactIndex: null,
            selectedRuleIndex: null,

            isEditingSourceName: false,

            openModal: {
                isOpen: false,
                name: ''
            },
            tactics: [],
            techniques: [],
            filteredAbilities: [],
            abilitySearch: {
                query: '',
                tactic: '',
                technique: null
            },
            abilities: [],
            adversaries: [],

            factIndexToDelete: -1,
            ruleIndexToDelete: -1,
            relationshipIndexToDelete: -1,

            showAddFactRow: false,
            showAddRuleRow: false,
            showAddRelationshipRow: false,

            newRelationship: {
                sourceTrait: '',
                edge: '',
                targetTrait: ''
            },
            sortSettings: {
                facts: '',
                rules: '',
                relationships: ''
            },

            getSources() {
                apiV2('GET', '/api/v2/sources').then((sources) => {
                    this.sources = sources.sort((a, b) => a.name.toLowerCase() > b.name.toLowerCase());
                    this.handleSelectSource();
                }).catch((error) => {
                    toast('Error loading page', false);
                    console.error(error);
                });
            },

            handleSelectSource() {
                if (!this.selectedSourceId) return;
                this.selectedSource = this.sources.find((source) => source.id === this.selectedSourceId);
                this.filteredFacts = this.selectedSource.facts;
                this.filteredRules = this.selectedSource.rules;
                this.filteredRelationships = this.selectedSource.relationships;

                // Keep incoming objects sorted, as before
                Object.keys(this.sortSettings).forEach((k) => {
                    if (this.sortSettings[k]) {
                        let key = k[0].toUpperCase() + k.slice(1).toLowerCase();
                        let val = this.sortSettings[k];
                        this.sortTable(val, this[`filtered${key}`], k);
                    }
                });
            },

            filterFacts(input = '') {
                input = input.toLowerCase();
                this.filteredFacts = this.selectedSource.facts.filter((f) => (f.trait.toLowerCase().includes(input) || f.value.toLowerCase().includes(input)));
            },

            filterRules(input = '') {
                input = input.toLowerCase();
                this.filteredRules = this.selectedSource.rules.filter((r) => (r.match.toLowerCase().includes(input) || r.trait.toLowerCase().includes(input)));
            },

            filterRelationships(input = '') {
                input = input.toLowerCase();
                this.filteredRelationships = this.selectedSource.relationships.filter((r) => (r.source.trait.toLowerCase().includes(input) || r.target.trait.toLowerCase().includes(input)));
            },

            createSource() {
                const newSource = {
                    name: 'New source',
                    facts: [],
                    rules: [],
                    relationships: []
                };
                apiV2('POST', '/api/v2/sources', newSource).then((src) => {
                    toast('Added new fact source', true);
                    this.isEditingSourceName = true;
                    this.sources.push(src);
                    this.selectedSourceId = src.id;
                    this.selectedSource = src;
                    this.handleSelectSource();
                    this.$nextTick(() => {
                        document.getElementById('sourceName').focus();
                    });
                }).catch((error) => {
                    toast('Error adding source', false);
                    console.error(error);
                });
            },

            getFilters(abilities) {
                abilities.forEach((a) => {
                    this.tactics.push(a.tactic);
                    this.techniques.push(`${a.technique_id} | ${a.technique_name}`);
                });
                this.tactics = [...new Set(this.tactics)].sort();
                this.techniques = [...new Set(this.techniques)].sort();
            },

            filterAbilities() {
                apiV2('GET', '/api/v2/abilities').then((abilities) => {
                    this.getFilters(abilities);
                    this.filteredAbilities = getFilteredAbilities(abilities, this.abilitySearch.query, this.abilitySearch.tactic, this.abilitySearch.technique);
                    this.getAbilityFacts();
                }).catch((error) => {
                    toast('There was an error getting abilities', false);
                    console.error(error);
                });
            },

            getAbilityFacts() {
                let abilitiesWithFacts = [];
                this.filteredAbilities.forEach((a) => {
                    let factTraits = [];
                    if (a.executors) {
                        a.executors.forEach((e) => {
                            if (e.command) {
                                const m = [...e.command.matchAll(/#{(.*?)}/gm)];
                                if (m && m.length > 0) factTraits = factTraits.concat(m.map((variable) => variable[1])); // find all abilities where an executor has a command with a ${} fact variable
                            }
                        });
                        if (factTraits.length > 0) {
                            abilitiesWithFacts.push({
                                ...a,
                                score: 1,
                                factTraits: [...new Set(factTraits)]
                            });
                        }
                    }
                });
                this.filteredAbilities = abilitiesWithFacts;
            },

            addFromAbility(factTraits, score, fromAdversary = false) { // add all facts found from abilities
                this.openModal.isOpen = false;
                factTraits.forEach((val) => {
                    this.addFact({
                        trait: val,
                        value: '',
                        score: score
                    }, true);
                });
                if (!fromAdversary) toast('Added facts to source', true);
            },

            getAdversaries() {
                apiV2('GET', '/api/v2/adversaries').then((adversaries) => {
                    this.adversaries = adversaries;
                    return apiV2('GET', '/api/v2/abilities');
                }).then((abilities) => {
                    this.abilities = abilities;
                }).catch((error) => {
                    toast('Error getting adversaries', false);
                    console.error(`Error getting adversaries: ${error}`);
                });
            },

            getAdversaryFacts(selectedAdversaryID) {
                const selectedAdversary = this.adversaries.find((adversary) => adversary.adversary_id === selectedAdversaryID);
                this.filteredAbilities = selectedAdversary.atomic_ordering.map((ability_id) => ({ ...this.abilities.find((ability) => ability.ability_id === ability_id) }));
                this.getAbilityFacts();
            },

            addFromAdversary() {
                this.filteredAbilities.forEach((a) => {
                    if (a.factTraits) {
                        this.addFromAbility(a.factTraits, a.score, true);
                    }
                });
            },

            duplicateSource(source) {
                const newSource = {
                    ...source,
                    name: `${source.name} (copy)`,
                    id: ''
                };
                apiV2('POST', '/api/v2/sources', newSource).then((src) => {
                    this.sources.push(src);
                    this.selectedSourceId = src.id;
                    this.selectedSource = src;
                    this.handleSelectSource();
                    toast('Duplicated fact source', true);
                }).catch((error) => {
                    toast('Error duplicating source', false);
                    console.error(error);
                });
            },

            addFact(newFact, bulkAdd = false) {
                const updatedSource = { ...this.selectedSource };
                updatedSource.facts.push(newFact);
                apiV2('PUT', `/api/v2/sources/${this.selectedSource.id}`, updatedSource).then((res) => {
                    if (!bulkAdd) toast('Updated source', res);
                    this.showAddFactRow = false;
                    this.getSources();
                }).catch((error) => {
                    toast('Error adding fact', false);
                    console.error(error);
                });
            },

            validateRule(newRule) {
                return !this.selectedSource.rules.find((r) => (r.match === newRule.match && r.trait === newRule.trait));
            },

            addRule(newRule) {
                if (!this.validateRule(newRule)) {
                    toast('Error: Rule already exists');
                    return;
                }
                const updatedSource = { ...this.selectedSource };
                updatedSource.rules.push(newRule);
                apiV2('PUT', `/api/v2/sources/${this.selectedSource.id}`, updatedSource).then((res) => {
                    toast('Updated source', true);
                    this.showAddRuleRow = false;
                    this.getSources();
                }).catch((error) => {
                    toast('Error adding rule', false);
                    console.error(error);
                });
            },

            addRelationship() {
                const updatedSource = { ...this.selectedSource };
                updatedSource.relationships.push({
                    source: { trait: this.newRelationship.sourceTrait },
                    target: { trait: this.newRelationship.targetTrait },
                    edge: this.newRelationship.edge
                });
                apiV2('PUT', `/api/v2/sources/${this.selectedSource.id}`, updatedSource).then((res) => {
                    toast('Updated source', true);
                    this.showAddRelationshipRow = false;
                    this.newRelationship.sourceTrait = '';
                    this.newRelationship.targetTrait = '';
                    this.newRelationship.edge = '';
                    this.getSources();
                }).catch((error) => {
                    toast('Error adding relationship', false);
                    console.error(error);
                });
            },

            deleteSource() {
                apiV2('DELETE', `/api/v2/sources/${this.selectedSourceId}`).then((res) => {
                    toast('Deleted fact source', true);
                    this.selectedSourceId = '';
                    this.selectedSource = {
                        name: '',
                        relationships: []
                    };
                    this.getSources();
                }).catch((error) => {
                    toast('Error deleting source', false);
                    console.error(error);
                });
            },

            deleteFact(index) {
                this.selectedSource.facts.splice(index, 1);
                this.factIndexToDelete = -1;
                this.updateFactSource();
            },

            deleteRule(index) {
                this.selectedSource.rules.splice(index, 1);
                this.ruleIndexToDelete = -1;
                this.updateFactSource();
            },

            deleteRelationship(index) {
                this.selectedSource.relationships.splice(index, 1);
                this.relationshipIndexToDelete = -1;
                this.updateFactSource();
            },

            saveSourceName() {
                if (!this.selectedSource.name) {
                    toast('Source name cannot be blank', false);
                    return;
                }

                apiV2('PATCH', `/api/v2/sources/${this.selectedSource.id}`, { name: this.selectedSource.name }).then((res) => {
                    toast('Source name updated', true);
                    this.isEditingSourceName = false;
                }).catch((error) => {
                    toast('Error loading page', false);
                    console.error(error);
                });
            },

            updateFactSource() {
                apiV2('PATCH', `/api/v2/sources/${this.selectedSource.id}`, this.selectedSource).then((res) => {
                    toast('Updated source', true);
                    this.selectedFactIndex = -1;
                    this.selectedRuleIndex = -1;
                    this.selectedRelationshipIndex = -1;
                    this.getSources();
                }).catch((error) => {
                    toast('Error loading page', false);
                    console.error(error);
                });
            },

            resetSearch() {
                this.abilitySearch = {
                    query: '',
                    tactic: '',
                    technique: null
                };
                this.filterAbilities();
            },

            sortTable(field, list, objName) {
                if (list && list.length > 0 && field in list[0]) {
                    let reverseSortOrder = this.sortSettings[objName] === field.toUpperCase();
                    list.sort((a, b) => {
                        if (!(field in a)) return 0;
                        if (!(field in b)) return 0;
                        // if already sorted once (upper case), sort in reverse order
                        if (reverseSortOrder) return a[field] < b[field] ? 1 : b[field] < a[field] ? -1 : 0;
                        return a[field] > b[field] ? 1 : b[field] > a[field] ? -1 : 0;
                    });
                    this.sortSettings[objName] = reverseSortOrder ? field.toLowerCase() : field.toUpperCase();
                }
                return list;
            },
        };
    }

    // # sourceURL=sources.js
</script>

<style>
    #sourcePage .box.selectable:hover, .box.selected {
        cursor: hand;
        border: 2px solid white;
    }

    #sourcePage .box span {
        word-break: break-all;
    }

    #sourcePage .box p {
        word-break: break-word;
    }

    #sourcePage .w-50-px {
        width: 50px;
    }

    #sourcePage .text-align-center {
        text-align: center !important;
    }

    #sourcePage button.no-style {
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    #sourcePage button.no-style.button-link {
        cursor: hand;
        text-decoration: underline;
    }

    #sourcePage .collapsible-header .expanded::after {
        text-decoration: none;
        margin-left: 0.5rem;
        font-size: 0.7em;
        content: "▼";
    }

    #sourcePage .collapsible-header .collapsed::after {
        text-decoration: none;
        margin-left: 0.5rem;
        font-size: 0.7em;
        content: "►";
    }

    #sourcePage .collapsible-header button > span:focus, .collapsible-header button > span:hover, .collapsible-header button > span:active {
        color: inherit !important;
        text-decoration: underline;
        text-decoration-style: dotted;
    }

    #sourcePage table tbody tr:hover, table tbody tr.selected {
        cursor: pointer;
    }

    #sourcePage table td {
        vertical-align: middle !important;
    }

    /*IMPORTED*/
    #sourcePage span.origin-IMPORTED {
        background-color: transparent;
    }

    /*SEEDED*/
    #sourcePage span.origin-SEEDED {
        background-color: #4a9;
    }

    /*LEARNED*/
    #sourcePage span.origin-LEARNED {
        background-color: #ffc500;
    }

    /*USER*/
    #sourcePage span.origin-USER {
        background-color: #a05195;
    }

    /*DOMAIN*/
    #sourcePage span.origin-DOMAIN {
        background-color: cornflowerblue;
    }

    #select-source {
        max-width: 800px;
        margin: 0 auto;
    }

</style>
