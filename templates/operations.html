<div id="operationsPage" x-data="alpineOperations()" x-init="initOperations()"
     class="operations-page"
     xmlns="http://www.w3.org/1999/html"
     @resize.window="getOperationsMenuCaretDisplay()">
    <div>
        <div>
            <div x-ref="operationsHeader">
                <h2>Operations</h2>
                <p>
                    Start a new operation or review previous ones here.
                </p>
            </div>
            <hr>
        </div>

        <div>
            <div x-bind:class="isOperationsControlsExpanded ? '' : 'is-flex is-justify-content-space-between'">
                <div class="is-flex-direction-column"
                     x-bind:class="isOperationsControlsExpanded ? '' : 'is-half pb-0 m-2'">
                    <div class="pl-0 is-flex is-align-content-flex-start mb-2"
                         x-data="{startOperation: EMPTY_OPERATIONS_OBJECT}">
                        <div x-bind:class="isOperationsControlsExpanded ? 'is-one-fifth' : ''">
                            <div class="field has-addons">
                                <div class="control has-icons-left">
                                    <input class="input is-small"
                                           id="op-search"
                                           placeholder="Find an operation..."
                                           x-ref="search"
                                           x-on:keyup="filterOperations($el.value)">
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </div>
                                <div class="control">
                                    <a class="button is-small"
                                       x-on:click="filterOperations(''); searchInput = ''; $refs.search.value=''">
                                        <span class="icon is-small is-right">
                                            <i class="fas fa-times"></i>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div>&nbsp;&nbsp;</div>
                        <button x-bind:disabled="!(searchInput && filteredOperations.length === 0)" type="button"
                                title="creates a new operation based on the last created operation settings "
                                class="button is-primary is-small"
                                x-on:click="addOperation(true, startOperation)"><i class="pr-1 fas fa-plus"></i>
                            Quick Add
                        </button>
                        <button type="button" title="add operation" class="ml-2 button is-primary is-small"
                                x-on:click="openModal = 'addOperation'; getAgents()"><i class="pr-1 fas fa-plus"></i>
                            Create Operation
                        </button>
                    </div>
                    <div class="is-flex is-flex-direction-row is-align-items-center">
                        <div class="is-flex is-flex-direction-row is-justify-content-flex-start operation-menu-container">
                            <template x-if="filteredOperations.length < 1">
                                <em class="is-flex is-justify-content-center">No operations available; click on the
                                    'Create Operation' button to get started.</em>
                            </template>
                            <template x-for="op in filteredOperations" :key="op.id">
                                <button class="no-style operation-menu-links"
                                        x-bind:title="op.name + ' has ' + op.chain.length + ' decisions'"
                                        x-on:click="selectedOperation = op; getOperations(); getOperation()">
                                    <i x-show="selectedOperationID !== op.id" class="far fa-folder">
                                        <span class="decisionsIcon" x-text="op.chain.length"></span></i>
                                    <i x-show="selectedOperationID === op.id" class="far fa-folder-open"></i>
                                    <span x-text="op.name"></span>
                                    <span class="readable-time" x-text="getHumanFriendlyTime(op.start)"></span>
                                </button>
                            </template>
                        </div>
                        <template x-if="showOperationsMenuCaret">
                            <div class="ml-2 scroll-more-caret">
                                <i class="fas fa-angle-right"></i>
                            </div>
                        </template>
                    </div>
                </div>


                <div x-bind:class="isOperationsControlsExpanded ? '' : 'is-half pb-0 m-2'">
                    <template x-if="selectedOperation">
                        <div x-show="selectedOperationID">
                            <template x-if="isOperationsControlsExpanded">
                                <div class="ellipsis-divider mt-2 mb-3">
                                    <i class="fas fa-circle"></i>
                                    <i class="fas fa-circle"></i>
                                    <i class="fas fa-circle"></i>
                                </div>
                            </template>
                            <div class="is-flex is-flex-direction-row mt-2">
                                <div class="is-flex is-flex-direction-column is-justify-content-center mx-5">
                                    <div class="is-flex is-flex-direction-row is-justify-content-center mt-2 ml-5">
                                        <div class="mr-6">
                                            <h3 class="my-1 is-size-4" x-text="selectedOperation.name"></h3>
                                            <h2 class="is-size-6 has-text-weight-normal mb-5 mt-0">Operation</h2>
                                        </div>
                                        <div class="mr-6">
                                            <h3 class="my-1 is-size-5" x-text="selectedOperation.state"></h3>
                                            <h2 class="is-size-7 has-text-weight-normal mb-5 mt-0">Current state</h2>
                                        </div>
                                        <div class="mr-6">
                                            <h3 class="decisionsDisplay my-1 is-size-5"
                                                x-text="selectedOperation.chain.length"></h3>
                                            <h2 class="is-size-7 has-text-weight-normal mb-5 mt-0">Decisions</h2>
                                        </div>
                                    </div>
                                    <div class="controls-container is-flex is-justify-content-center is-align-items-center">
                                        <button x-bind:disabled="!isOperationRunning" class="button no-style is-large"
                                                x-on:click="updateOperation('state', 'cleanup')"><i
                                                title="stop" class="fas fa-stop"></i></button>
                                        <template x-if="selectedOperation.state ==='running'">
                                            <button x-bind:disabled="!isOperationRunning"
                                                    class="button no-style is-larger"
                                                    x-on:click="updateOperation('state', 'paused')"><i
                                                    title="pause" class="fas fa-pause-circle"></i></button>
                                        </template>
                                        <template x-if="selectedOperation.state !== 'running'">
                                            <button x-bind:disabled="!isOperationRunning"
                                                    class="button no-style is-larger"
                                                    x-on:click="updateOperation('state', 'running')">
                                                <i title="run" class="fas fa-play-circle"></i></button>
                                        </template>
                                        <button x-bind:disabled="!isOperationRunning" class="button no-style is-medium"
                                                x-on:click="updateOperation('state', 'run_one_link')">
                                            <i title="run one step" class="fas fa-play"><sub>1</sub></i></button>
                                    </div>

                                    <template x-if="isOperationsControlsExpanded">
                                        <div class="is-flex is-justify-content-center pt-2">
                                            <button title="download event logs"
                                                    class="mx-2 button no-style"
                                                    x-on:click="openModal = 'showDownloadMenu'"><i
                                                    class="pr-1 fas fa-arrow-down"></i>
                                            </button>
                                            <button type="button" title="delete operation"
                                                    class="mx-2 button no-style"
                                                    x-on:click="openModal = 'deleteOperationModal'"><i
                                                    class="pr-1 fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </template>
                                </div>

                                <template x-if="isOperationsControlsExpanded">
                                    <div class="is-flex is-flex-direction-column is-flex-wrap-wrap mx-5">
                                        <div class="mb-4">
                                            <label x-show="false" for="operation-obfuscator" class="is-size-6">
                                                Obfuscation method:
                                            </label>
                                            <template x-if="!isOperationRunning">
                                                <div class="is-flex is-justify-content-center">
                                                    <button class="is-small button is-rounded chip m-1"
                                                            x-text="selectedOperation.obfuscator + ' obfuscation'"></button>
                                                </div>
                                            </template>
                                            <template x-if="isOperationRunning">
                                                <div class="is-flex is-flex-direction-row is-flex-wrap-wrap is-justify-content-center pb-2"
                                                     id="operation-obfuscator">
                                                    {% for o in obfuscators %}
                                                    <button x-bind:class="selectedOperation.obfuscator === `{{ o.name|e }}` ? '' : 'is-outlined has-text-white'"
                                                            class="is-small button is-rounded is-primary chip m-1"
                                                            x-on:click="updateOperation('obfuscator', `{{ o.name|e }}`)">
                                                        {{ o.name|e }}
                                                    </button>
                                                    {% endfor %}
                                                </div>
                                            </template>
                                        </div>

                                        <template x-if="isOperationRunning">
                                            <div class="is-flex is-flex-direction-row is-justify-content-center is-align-items-center width-100">
                                                <div class="toggleContainer">
                                                    <label for="toggleAutonomous">Manual</label>
                                                    <div class="toggleSwitch mx-2">
                                                        <input type="checkbox"
                                                               id="toggleAutonomous"
                                                               x-model="selectedOperation.autonomous"
                                                               x-bind:checked="Boolean(selectedOperation.autonomous) ? 'checked' : null"/>
                                                        <span class="toggleSlider toggleSliderRound"
                                                              x-on:click="selectedOperation.autonomous = (selectedOperation.autonomous === 0) ? 1 : 0; updateOperation('autonomous', Number(selectedOperation.autonomous))"
                                                              x-bind:class="Boolean(selectedOperation.autonomous) ? 'toggle-on' : 'toggle-off'">
                                                        <span x-bind:class="Boolean(selectedOperation.autonomous) ? 'toggle-slider-on' : 'toggle-slider-off'"></span>
                                                    </span>
                                                    </div>
                                                    <label for="toggleAutonomous">Autonomous</label>
                                                </div>
                                            </div>
                                        </template>

                                        <template x-if="!isOperationRunning">
                                            <div class="is-flex is-justify-content-center mt-5">
                                                <em>Operation has finished running.</em>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>

                        </div>
                    </template>
                </div>
            </div>

            <template x-if="filteredOperations.length > 0 && !selectedOperation">
                <em class="is-flex is-justify-content-center">Click on an operation above to get started.</em>
            </template>

            <template x-if="selectedOperation">
                <div class="width-100 is-flex is-justify-content-center">
                    <button class="button no-style caret-button"
                            type="button"
                            x-on:click="isOperationsControlsExpanded = !isOperationsControlsExpanded; getOperationsMenuCaretDisplay()">
                        <i x-show="isOperationsControlsExpanded" class="fas fa-angle-up" title="show less"></i>
                        <i x-show="!isOperationsControlsExpanded" class="fas fa-angle-down" title="show more"></i>
                    </button>
                </div>
            </template>

            <!--            TIMELINE-->
            <div>
                <template x-if="selectedOperation">
                    <div x-show="selectedOperationID">
                        <div class="navbar-divider mb-5 width-100"></div>
                        <div class="timeline-table">
                            <table class="table">
                                <thead>
                                <tr class="table-header">
                                    <th class="decideColumn">Decide & Status</th>
                                    <th title="Link Status Indicator" class="csv-exclude"></th>
                                    <th class="infoColumn">Link/Ability Name</th>
                                    <th>Agent #paw</th>
                                    <th>Link Command</th>
                                    <th>Link Output & Facts</th>
                                    <th title="Link Actions" class="csv-exclude"></th>
                                </tr>
                                </thead>

                                <template x-if="selectedOperation.chain.length === 0">
                                    <tbody>
                                    <tr class="csv-exclude">
                                        <td colspan="7"><em>No links––click the buttons on the right to add
                                            commands/links.</em>
                                        </td>
                                    </tr>
                                    </tbody>
                                </template>
                                <template x-for="(link, index) in selectedOperation.chain" :key="link.id">
                                    <tbody>
                                    <tr x-bind:id="link.id"
                                        x-bind:class="selectedLink === link ? 'selected' : ''"
                                        x-on:click="getLink(link)">
                                        <td class="decideColumn">
                                            <span class="has-text-grey-light" x-text="link.decide"></span>
                                            <span x-bind:class="'status-'+((link.status in LINK_STATUSES) ? LINK_STATUSES[link.status] : 'queued')"
                                                  x-text="(link.status in LINK_STATUSES) ? LINK_STATUSES[link.status] : 'queued'"></span>
                                            <span class="pending-warning"
                                                  x-show="link.status === -1 && selectedOperation.autonomous === 0">pending approval</span>
                                        </td>
                                        <td class="linkStatusColumn csv-exclude">
                                                    <span x-bind:title="(link.status in LINK_STATUSES) ? LINK_STATUSES[link.status] : 'queued'"
                                                          x-bind:class="'linkStatus status-'+((link.status in LINK_STATUSES) ? LINK_STATUSES[link.status] : 'queued')"></span>
                                        </td>
                                        <td class="linkInfoColumn"
                                            x-text="link.ability.name + ((link.ability.cleanup) ? '(CLEANUP)' : '')"></td>

                                        <!--AGENT COLUMN-->
                                        <td class="agentDetails"
                                            x-bind:class="selectedLink === link ? '' : 'linkInfoColumn'">
                                            <p x-show="link.paw">Agent #<em x-text="link.paw"></em></p>
                                            <p x-show="selectedLink === link && link.host">Host: <em
                                                    x-text="link.host"></em></p>
                                            <p x-show="selectedLink === link && link.pid">Pid: <em
                                                    x-text="link.pid"></em></p>
                                        </td>

                                        <!--COMMAND COLUMN-->
                                        <td class="commandDetails">
                                            <template x-if="index === 0 && !selectedLink">
                                                <em>Click on a link to show more details.</em>
                                            </template>
                                            <template
                                                    x-if="selectedLink === link && !isLinkEditable">
                                                <div class="is-flex is-justify-content-center is-flex-direction-column">
                                                    <label x-show="false" for="view-command">View command</label>
                                                    <textarea id="view-command"
                                                              class="code"
                                                              readonly
                                                              x-text="selectedLinkCommand"
                                                              spellcheck="false"></textarea>
                                                </div>
                                            </template>
                                            <template x-if="selectedLink === link && isLinkEditable">
                                                <div class="is-flex is-align-items-flex-end is-justify-content-center is-flex-direction-column">
                                                    <label x-show="false" for="edit-command">Edit command</label>
                                                    <textarea id="edit-command"
                                                              class="code"
                                                              contenteditable
                                                              x-model="editableCommand"
                                                              spellcheck="false"></textarea>

                                                    <!-- BUTTONS TO MANUALLY EXECUTE (APPROVE/DISCARD) COMMAND-->
                                                    <div class="is-flex is-justify-content-space-between">
                                                        <button type="button"
                                                                class="button is-small mr-3"
                                                                x-on:click="updateLink(-2)">
                                                            Discard
                                                        </button>
                                                        <button type="button"
                                                                class="button is-primary is-small"
                                                                x-on:click="updateLink(-3, editableCommand)">
                                                            Approve
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>
                                        </td>

                                        <!--OUTPUT/FACTS COLUMN-->
                                        <!--TODO if output is T, should show facts; individual links should have their own facts, TBD-->
                                        <td class="outputDetails">
                                            <template x-if="selectedLink === link && !selectedLinkResults">
                                                <p class="is-size-7">No output available.</p>
                                            </template>
                                            <template x-if="selectedLink === link && selectedLinkResults">
                                                <div class="mb-5">
                                                    <p class="is-size-7">Output: </p>
                                                    <code class="is-size-7" x-text="selectedLinkResults"></code>
                                                </div>
                                            </template>

                                            <!--                                            TODO how should facts be shown?-->
                                            <!--                                            <template x-if="selectedLink === link && selectedLinkFacts?.length > 0">-->
                                            <!--                                                <div class="mb-5">-->
                                            <!--                                                    <p class="is-size-7">Facts: </p>-->
                                            <!--                                                    <template x-for="(fact, index) in selectedLinkFacts"-->
                                            <!--                                                              :key="link.id+'-'+index">-->
                                            <!--                                                        <code x-bind:id="index" class="highlight"-->
                                            <!--                                                              x-text="fact.score + (index < selectedLinkFacts.length - 1 ? ', ' : ' ')"></code>-->
                                            <!--                                                    </template>-->
                                            <!--                                                </div>-->
                                            <!--                                            </template>-->
                                            <!--                                            <template x-if="selectedLink === link && selectedLinkFacts?.length < 1">-->
                                            <!--                                                <p class="is-size-7">No facts available.</p>-->
                                            <!--                                            </template>-->
                                        </td>

                                        <td class="csv-exclude">
                                            <template
                                                    x-if="selectedLink === link && isOperationRunning && link.status !== -2">
                                                <button type="button" title="delete link"
                                                        class="button is-primary is-small ml-2"
                                                        x-on:click="openModal = 'deleteLinkModal'"><i
                                                        class="pr-1 fas fa-trash"></i>Discard Link
                                                </button>
                                            </template>
                                        </td>
                                    </tr>
                                    </tbody>
                                </template>

                                <!--                                NEW ROW TO ADD MANUAL COMMAND-->
                                <tbody>
                                <template x-if="addNewRow">
                                    <tr class="csv-exclude" x-data="{manualCommand: EMPTY_MANUAL_COMMAND_OBJECT}">
                                        <td></td>
                                        <td></td>
                                        <td>New Manual Command</td>
                                        <td>
                                            <label x-show="false" for="manual-agent">Choose an agent:</label>
                                            <div class="select is-small my-2 ml-3">
                                                <select id="manual-agent" x-model="selectedAgentIndex" required>
                                                    <option disabled>Choose agent</option>
                                                    <template x-for="(agent, index) in selectedOperation.host_group"
                                                              :key="agent.paw">
                                                        <option x-bind:selected="index === 0"
                                                                :value="index"
                                                                x-text="agent.display_name + '-' + agent.paw"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="select is-small my-2 ml-3">
                                                <select x-model="manualCommand.executor.name"
                                                        id="manual-executors"
                                                        class="executor-selector">
                                                    <option disabled>Choose executor</option>
                                                    <template
                                                            x-for="(executor, index) in selectedAgentExecutors"
                                                            :key="executor.name">
                                                        <option x-text="executor"
                                                                :value="selectedAgent?.executors[index]"
                                                                x-bind:selected="index === 0"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </td>
                                        <td>
                                            <label x-show="false" for="input-command">Type manual command:</label>
                                            <div class="is-flex is-align-items-flex-end is-justify-content-center is-flex-direction-column">
                                                <textarea x-model="manualCommand.executor.command"
                                                          class="input executor-command"
                                                          id="input-command"
                                                          type="text"
                                                          spellcheck="false"
                                                          contenteditable
                                                          required></textarea>
                                            </div>
                                        </td>
                                        <td class="is-flex is-justify-content-center is-flex-direction-column">
                                            <button type="button"
                                                    class="button is-primary is-small my-2"
                                                    x-on:click="addManualCommand(manualCommand)">
                                                Add Command
                                            </button>
                                            <button type="button"
                                                    class="button is-small"
                                                    x-on:click="addNewRow = false">
                                                Cancel
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                </tbody>

                                <!--                                ADD COMMAND/LINK BUTTONS-->
                                <template x-if="isOperationRunning">
                                    <tfoot>
                                    <tr class="csv-exclude">
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td class="pt-6 text-align-right">
                                            <button title="add manual command" class="button is-primary is-small"
                                                    x-on:click="addNewRow = true; getAgents()">
                                                <i class="pr-1 fas fa-plus"></i>Manual
                                                Command
                                            </button>
                                        </td>
                                        <td class="pt-6">
                                            <button title="add potential link" class="button is-primary is-small"
                                                    x-on:click="openModal = 'addLink'; getAgents()"><i
                                                    class="pr-1 fas fa-plus"></i>Potential
                                                Link
                                            </button>
                                        </td>
                                    </tr>
                                    </tfoot>
                                </template>
                            </table>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!--    MODALS      -->
        <template x-if="openModal">
            <div class="modal is-active">
                <div class="modal-background" @click="openModal = null"></div>
                <form class="m-1">
                    <div class="modal-card" x-data="{startOperation: EMPTY_OPERATIONS_OBJECT}">
                        <template x-if="openModal === 'addOperation'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Start New Operation</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="op-name">Operation name</label>
                                            <div class="modal-form-fields">
                                                <input class="input is-small" id="op-name" type="text"
                                                       x-model="startOperation.name" required>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="basic-adversary"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Adversary']">Adversary</span></label>
                                            <div class="modal-form-fields" id="basic-adversary">
                                                <div class="select is-small my-2 ml-3">
                                                    <select x-model="startOperation.adversary.adversary_id">
                                                        <option value="" selected>No adversary (manual)</option>
                                                        {% for adv in adversaries %}
                                                        <option x-on:click="isSelectedAdversaryRepeatable = {{ adv.has_repeatable_abilities }}"
                                                                value="{{ adv.adversary_id|e }}">
                                                            {{ adv.name|e }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="autonomous-source"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Fact source']">Fact source</span></label>
                                            <div class="modal-form-fields" id="autonomous-source">
                                                <div class="select is-small my-2 ml-3">
                                                    <select x-model="startOperation.source.id">
                                                        {% for s in sources %}
                                                        <option>{{ s.name|e }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="modal-form-group-header">
                                        <button type="button" class="button no-style heading pt-2"
                                                x-on:click="openModalForm.advanced = !openModalForm.advanced"
                                                x-bind:class="openModalForm.advanced ? 'expanded' : 'collapsed'">
                                            <span>Advanced</span>
                                            <span class="navbar-divider"></span>
                                        </button>
                                    </div>
                                    <div class="modal-form" x-show="openModalForm.advanced">
                                        <div>
                                            <label for="basic-groups"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Group']">Group</span></label>
                                            <div class="modal-form-fields"
                                                 id="basic-groups">
                                                <button type="button"
                                                        class="is-small button is-rounded is-primary chip m-1"
                                                        x-bind:class="(startOperation.group === '') ? '' : 'is-outlined has-text-white'"
                                                        x-on:click="startOperation.group = ''">
                                                    all groups
                                                </button>
                                                <template x-for="(group, index) in agentGroups" :key="group">
                                                    <button type="button"
                                                            class="is-small button is-rounded is-primary chip m-1"
                                                            x-bind:class="(startOperation.group === group) ? '' : 'is-outlined has-text-white'"
                                                            x-on:click="startOperation.group = group"
                                                            x-show="group !== ''"
                                                            x-text="group">
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="autonomous-planner"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Planner']">Planner</span></label>
                                            <div class="modal-form-fields">
                                                <div class="select is-small my-2 ml-3">
                                                    <select id="autonomous-planner" x-model="startOperation.planner.id">
                                                        {% for p in planners %}
                                                        {% if p.allow_repeatable_abilities %}
                                                        <option data-allow-repeatable-abilities>
                                                            {{ p.name|e }}
                                                        </option>
                                                        {% else %}
                                                        <option x-bind:disabled="isSelectedAdversaryRepeatable ? 'true' : null">
                                                            {{ p.name|e }}
                                                        </option>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="stealth-obfuscator"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Obfuscators']">Obfuscators</span></label>
                                            <div class="modal-form-fields" id="stealth-obfuscator">
                                                {% for o in obfuscators %}
                                                <button class="is-small button is-rounded is-primary chip m-1"
                                                        type="button"
                                                        x-bind:class="startOperation.obfuscator === `{{ o.name|e }}` ? '' : 'is-outlined has-text-white'"
                                                        x-on:click="startOperation.obfuscator = `{{ o.name|e }}`">
                                                    {{ o.name|e }}
                                                </button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div>
                                            <label for="autonomous-autonomous"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Autonomous']">Autonomous</span></label>
                                            <div class="modal-form-fields" id="autonomous-autonomous">
                                                <input type="radio" id="run-autonomously"
                                                       x-model="startOperation.autonomous" value="1" checked>
                                                <label for="run-autonomously">Run autonomously</label>
                                                <input type="radio" id="manual-approval"
                                                       x-model="startOperation.autonomous" value="0">
                                                <label for="manual-approval">Require manual approval</label>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="autonomous-use_learning_parsers"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Parser']">Parser</span></label>
                                            <div class="modal-form-fields" id="autonomous-use_learning_parsers">
                                                <input type="radio" id="parsers-default"
                                                       x-model="startOperation.use_learning_parsers" value="1" checked>
                                                <label for="parsers-default">Use default parsers</label>
                                                <input type="radio" id="parsers-no_default"
                                                       x-model="startOperation.use_learning_parsers" value="0">
                                                <label for="parsers-no_default">Do not use default parsers</label>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="basic-keep"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Auto-close']">Auto-close</span></label>
                                            <div class="modal-form-fields" id="basic-keep">
                                                <input type="radio" id="keep-open"
                                                       x-model="startOperation.auto_close"
                                                       value="0" checked>
                                                <label for="keep-open">Keep open forever</label>
                                                <input type="radio" id="auto-close"
                                                       x-model="startOperation.auto_close"
                                                       value="1">
                                                <label for="auto-close">Auto close operation</label>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="basic-run"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Run immediately']">Run state</span></label>

                                            <div class="modal-form-fields" id="basic-run">
                                                <input type="radio" x-model="startOperation.state"
                                                       id="run-immediately"
                                                       value="running" checked>
                                                <label for="run-immediately">Run immediately</label>
                                                <input type="radio" x-model="startOperation.state"
                                                       id="pause-on-start"
                                                       value="paused">
                                                <label for="pause-on-start">Pause on start</label>
                                            </div>
                                        </div>


                                        <!--                                        <div>-->
                                        <!--                                            <label for="autonomous-cleanup_timeout"><span-->
                                        <!--                                                    class="has-tooltip-multiline has-tooltip-bottom"-->
                                        <!--                                                    x-bind:data-tooltip="usage['Cleanup timeout']">Cleanup timeout (sec)</span></label>-->
                                        <!--                                            <div class="modal-form-fields">-->
                                        <!--                                                <input id="autonomous-cleanup_timeout" class="input"-->
                                        <!--                                                       x-model="startOperation.timeout" type="number"-->
                                        <!--                                                       placeholder="30" value="30" min="0" max="300"-->
                                        <!--                                                       x-on:change.once="toast('The number of seconds Caldera will wait per cleanup action to complete before continuing.', true)">-->
                                        <!--                                                <button type="button" class="button is-primary no-style reset"-->
                                        <!--                                                        title="reset to default"-->
                                        <!--                                                        x-on:click="startOperation.timeout = 30">-->
                                        <!--                                                    Reset-->
                                        <!--                                                </button>-->
                                        <!--                                            </div>-->
                                        <!--                                        </div>-->

                                        <div>
                                            <label for="stealth-jitter"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Jitter']">Jitter (sec/sec)</span></label>
                                            <div class="modal-form-fields" id="stealth-jitter">
                                                <input class="input"
                                                       x-on:change.debounce.500ms="validateJitter(startOperation, jitterMin+'/'+jitterMax)"
                                                       x-model="jitterMin"
                                                       id="stealth-jitterMin"
                                                       type="number"
                                                       required
                                                       pattern="[0-9]*"
                                                       placeholder="4"/>
                                                <label class="input-hover-label" for="stealth-jitterMin">min</label>
                                                <span>/</span>
                                                <input class="input"
                                                       x-on:change.debounce.500ms="validateJitter(startOperation, jitterMin+'/'+jitterMax)"
                                                       x-model="jitterMax"
                                                       id="stealth-jitterMax"
                                                       type="number"
                                                       required
                                                       pattern="[0-9]*"
                                                       placeholder="8"/>
                                                <label class="input-hover-label" for="stealth-jitterMax">max</label>
                                                <button type="button" class="button is-primary no-style reset"
                                                        title="reset to default"
                                                        x-on:click="jitterMin = 4; jitterMax = 8;">
                                                    Reset
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="stealth-queue"><span
                                                    class="has-tooltip-multiline has-tooltip-bottom"
                                                    x-bind:data-tooltip="usage['Visibility']">Visibility</span></label>
                                            <div class="modal-form-fields">
                                                <input x-model="startOperation.visibility"
                                                       id="stealth-queue"
                                                       type="range" value="50" min="1" max="100"
                                                       x-on:change.once="toast('The higher the visibility number, the more risk you will take with your operation getting noticed by the defense.', true)">
                                                <span x-text="startOperation.visibility"></span>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'addLink'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Add New Potential Link</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="link-agent">Agent</label>
                                            <div class="modal-form-fields">
                                                <div class="select is-small my-2 ml-3">
                                                    <select id="link-agent"
                                                            x-model="selectedAgentIndex"
                                                            x-on:change="getAgentLinks()">
                                                        <option disabled>Choose an agent...</option>
                                                        <template x-for="(agent, index) in selectedOperation.host_group"
                                                                  :key="agent.paw">
                                                            <option :value="index"
                                                                    x-bind:selected="index === 0"
                                                                    x-text="agent.display_name + '-' + agent.paw"></option>
                                                        </template>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="link-tactic">Tactic</label>
                                            <div class="modal-form-fields">
                                                <div class="select is-small my-2 ml-3">
                                                    <select id="link-tactic"
                                                            x-model="potentialLink.tactic"
                                                            x-on:change="filterAbilities()">
                                                        <option default value="">Choose a tactic...</option>
                                                        <template x-for="tactic in tacticFiltersList"
                                                                  :key="tactic">
                                                            <option x-text="tactic"></option>
                                                        </template>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="link-technique">Technique</label>
                                            <div class="modal-form-fields">
                                                <div class="select is-small my-2 ml-3">
                                                    <select id="link-technique"
                                                            x-model="potentialLink.technique"
                                                            x-on:change="filterAbilities()">
                                                        <option default>Choose a technique...</option>
                                                        <template x-for="technique in techniqueFiltersList"
                                                                  :key="technique">
                                                            <option x-text="technique"></option>
                                                        </template>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-results">
                                        <div class="navbar-divider"></div>
                                        <p class="is-flex is-justify-content-flex-end is-size-7"
                                           x-text="filteredLinksList.length + ' potential link' + ((filteredLinksList.length === 1) ? '' : 's')"></p>
                                        <template x-if="filteredLinksList">
                                            <ul>
                                                <template x-for="link in filteredLinksList" :key="link.ability.name">
                                                    <li>
                                                        <p x-text="link.ability.name"></p>
                                                        <button type="button"
                                                                class="button is-primary is-small"
                                                                x-bind:disabled="!isLinkAvailable(link)"
                                                                x-bind:title="!isLinkAvailable(link) ? 'Repeated links are not available for this operation, and link has been already added.' : ''"
                                                                x-on:click="addPotentialLink(link)">
                                                            Add Link
                                                        </button>
                                                    </li>
                                                </template>
                                            </ul>
                                        </template>
                                        <template x-if="!filteredLinksList"><p>Building potential links...</p>
                                        </template>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'showDownloadMenu'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Download</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="agent-output-field">Agent output</label>
                                            <div class="modal-form-fields" id="agent-output-field">
                                                <input id="agent-output"
                                                       x-bind:disabled="selectedReportType === 'csv'"
                                                       type="checkbox"
                                                       class="mr-1"
                                                       x-model="isAgentOutputSelected">
                                                <label for="agent-output">include agent output</label>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="report-type">Report type</label>
                                            <div class="modal-form-fields download-buttons-container" id="report-type">
                                                <input class="mr-1" type="radio" x-model="selectedReportType"
                                                       value="full-report" id="full-report">
                                                <label for="full-report">Full Report</label>
                                                <input class="mr-1" type="radio" x-model="selectedReportType"
                                                       value="event-logs" id="event-logs">
                                                <label for="event-logs">Event Logs</label>
                                                <input class="mr-1" type="radio" x-model="selectedReportType"
                                                       value="csv" id="csv">
                                                <label for="csv">CSV</label>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'deleteOperationModal'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Delete operation?</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <p>Are you sure you want to delete the operation <em
                                                    x-text="selectedOperation.name"></em>?</p>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </template>
                        <template x-if="openModal === 'deleteLinkModal'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Delete link?</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <p>Are you sure you want to delete the link <em
                                                    x-text="selectedLink.ability.name"></em>?</p>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <footer class="modal-card-foot is-flex is-justify-content-space-between is-align-items-center width-100">
                            <template x-if="openModal === 'addLink' || openModal === 'showDownloadMenu'">
                                <button type="button" class="button ml-2 is-small" x-on:click="openModal = null">
                                    Close
                                </button>
                            </template>
                            <template x-if="!(openModal === 'addLink' || openModal === 'showDownloadMenu')">
                                <button type="button" class="button ml-2 is-small" x-on:click="openModal = null">
                                    Cancel
                                </button>
                            </template>
                            <template x-if="openModal === 'deleteOperationModal'">
                                <button type="button" class="button is-primary is-small"
                                        x-on:click="deleteOperation(); openModal = null;">
                                    Yes
                                </button>
                            </template>
                            <template x-if="openModal === 'showDownloadMenu'">
                                <button type="button" class="button is-primary is-small"
                                        x-on:click="handleDownload()">
                                    Download
                                </button>
                            </template>
                            <template x-if="openModal === 'deleteLinkModal'">
                                <button type="button" class="button is-primary is-small"
                                        x-on:click="updateLink(-2); openModal = null;">
                                    Yes
                                </button>
                            </template>
                            <template x-if="openModal === 'addOperation'">
                                <button type="button" class="button is-primary is-small"
                                        x-on:click="addOperation(false, startOperation)"
                                        x-text="schedule ? 'Schedule' : 'Start'"></button>
                            </template>
                        </footer>
                    </div>
                </form>
            </div>
        </template>
    </div>
</div>

<script>
    function alpineOperations() {
        return {
            // CONSTANTS
            ENDPOINT: '/api/v2/operations',
            EXECUTOR_SHELLS: {
                psh: 'PS >',
                cmd: '>',
                sh: '$'
            },
            LINK_STATUSES: {
                0: 'success',
                '-1': 'paused',
                1: 'failed',
                '-2': 'discarded',
                '-3': 'collect',
                '-4': 'untrusted',
                '-5': 'visible',
                124: 'timeout'
            },

            docs: '{{ usage | tojson }}'.toString().replace(/["\[\]]/g, '').split('}'),
            usage: {},
            agentGroups: '{{ groups | tojson }}'.toString().replace(/["\[\]]/g, '').split(','),
            selectedOperation: null,
            selectedAgentIndex: null,
            isSelectedAdversaryRepeatable: false,
            selectedLink: null,
            selectedLinkResults: null,
            selectedLinkFacts: null,
            selectedLinkCommand: null,
            selectedReportType: '',
            isAgentOutputSelected: false,
            openModal: null,
            openModalForm: {
                advanced: false
            },
            operations: [],
            filteredOperations: [],
            searchInput: '',
            jitterMin: 4,
            jitterMax: 8,
            potentialLink: {
                agent: '',
                tactic: '',
                technique: '',
            },
            tacticFiltersList: [],
            techniqueFiltersList: [],
            filteredLinksList: [],
            schedule: '',
            editableCommand: null,
            isOperationsControlsExpanded: false,
            showOperationsMenuCaret: true,
            addNewRow: false,
            addedTechniquesIDs: new Set(),

            get EMPTY_OPERATIONS_OBJECT() {
                return {
                    name: '',
                    group: '',
                    adversary: {adversary_id: ''},
                    auto_close: 0,
                    state: 'running',
                    autonomous: 1,
                    planner: {id: 'atomic'},
                    source: {id: 'basic'},
                    use_learning_parsers: 1,
                    obfuscator: 'plain-text',
                    jitter: '4/8',
                    visibility: '51',
                }
            },

            get EMPTY_MANUAL_COMMAND_OBJECT() {
                return {
                    paw: '',
                    executor: {
                        name: '',
                        platform: '',
                        command: '',
                    }
                }
            },

            getUsage() {
                if (this.docs) {
                    this.docs.forEach((obj) => {
                        if (obj) {
                            let items = obj.split('{')[1].split(': ');
                            this.usage[items[0]] = items[1];
                        }
                    });
                }
            },

            get selectedOperationID() {
                return this.selectedOperation ? this.selectedOperation.id : null;
            },

            get selectedAgent() {
                if (!this.selectedOperation || this.selectedAgentIndex > this.selectedOperation.host_group.length) return null;
                return this.selectedOperation.host_group[this.selectedAgentIndex];
            },

            get selectedAgentExecutors() {
                return this.selectedAgent ? this.selectedAgent.executors.map((e) => this.EXECUTOR_SHELLS[e]) : [];
            },

            get isOperationRunning() {
                if (!this.selectedOperation) return false;
                return !(this.selectedOperation.state === 'finished' || this.selectedOperation.state === 'cleanup' || this.selectedOperation.state === 'out_of_time');
            },

            get isLinkEditable() {
                if (!this.selectedLink) return false;
                // Link can only be editable if operation is running, and if link is paused, queued, or completed
                // TODO check if this approve/discard condition is right
                return this.isOperationRunning && ((this.selectedLink.status === -1 || !(this.selectedLink.status in this.LINK_STATUSES))
                    && !(this.selectedLink.finish.length > 0 || this.selectedLink.output === 'True'));
            },

            getOperationsMenuCaretDisplay() {
                const el = document.querySelector('.operation-menu-container');
                setTimeout(() => {
                    this.showOperationsMenuCaret = el.scrollWidth > el.offsetWidth;
                }, 1); // timeout is to wait for UI changes to get accurate width calcs
            },

            // Controls whether user can add link or not--depending on whether adversary allows repeatable abilities, and ability has been added already or not
            isLinkAvailable(link) {
                return this.selectedOperation.adversary.has_repeatable_abilities ? true : !this.addedTechniquesIDs.has(link.technique_id);
            },

            generateAddedLinksList() {
                this.addedTechniquesIDs = new Set();
                this.selectedOperation.chain.forEach((link) => {
                    if (!this.addedTechniquesIDs.has(link.technique_id)) this.addedTechniquesIDs.add(link.technique_id);
                });
            },

            getAgentLinks(agent = this.selectedAgent) {
                this.potentialLink.agent = agent;
                this.tacticFiltersList = [];
                this.techniqueFiltersList = [];
                this.potentialLink.agent.links.forEach((link) => {
                    this.tacticFiltersList.push(link.ability.tactic);
                    this.techniqueFiltersList.push(link.ability.technique_name);
                });
                this.tacticFiltersList = sortAlphabetically(this.tacticFiltersList);
                this.techniqueFiltersList = sortAlphabetically(this.techniqueFiltersList);
                this.filteredLinksList = this.potentialLink.agent.links;
            },

            //
            // API CALLS
            //

            async initOperations() {
                this.getOperations();
                this.getUsage();

                function sleep(ms) {
                    return new Promise((resolve) => setTimeout(resolve, ms));
                }

                while (this.$refs.operationsHeader) {
                    await sleep(3000);
                    this.getOperations();
                }
            },

            getOperations() {
                apiV2('GET', this.ENDPOINT).then((res) => {
                    this.operations = res;
                    this.filterOperations(this.searchInput);
                }).catch((error) => {
                    toast('Error getting operations');
                });
            },

            getOperation() {
                if (this.selectedOperationID) {
                    apiV2('GET', `${this.ENDPOINT}/${this.selectedOperationID}`).then((res) => {
                        this.selectedLink = null;
                        this.selectedOperation = res;
                        this.generateAddedLinksList();
                        this.addNewRow = false;
                        // toast('Go to the GameBoard plugin to see if the blue team can detect your activities.', true);
                    }).catch((error) => {
                        toast('Error getting operation');
                    });
                } else {
                    toast('Select a valid operation to view.');
                }
            },

            addOperation(isQuickAdd = false, startOperation) {
                if (isQuickAdd) startOperation.name = this.searchInput;
                if (!startOperation.name) {
                    toast('Error: Operation name field is empty.');
                } else {
                    startOperation.autonomous = Number(startOperation.autonomous);
                    startOperation.use_learning_parsers = parseInt(startOperation.use_learning_parsers, 10) === 1;
                    startOperation.auto_close = parseInt(startOperation.auto_close, 10) === 1;

                    apiV2('POST', this.ENDPOINT, startOperation)
                        .then((res) => {
                            toast(`Started operation ${startOperation.name}!`, true);
                            this.getOperations();
                            this.selectedOperation = res;
                            this.openModal = null;
                            toast('Notice that you can pause or stop the operation at any time. Toggle into manual mode if you want full control or click potential links to add TTPs to the operation.', true);
                        }).catch((error) => {
                        toast('Error adding operation');
                    });
                }
            },

            deleteOperation() {
                apiV2('DELETE', `${this.ENDPOINT}/${this.selectedOperationID}`)
                    .then(() => {
                        this.selectedOperation = null;
                        this.getOperations();
                        toast('Deleted operation.', true);
                    })
                    .catch((error) => {
                        toast('Error deleting operation.');
                    });
            },

            getAgents() {
                apiV2('GET', 'api/v2/agents')
                    .then((res) => {
                        this.updateAgentGroups(res);
                        this.getAgentLinks(res[0]);
                        this.selectedAgentIndex = 0;
                    })
                    .catch((error) => {
                        toast('Error getting agents.');
                    });
            },

            addManualCommand(manualCommand) {
                if (!manualCommand.executor.command) {
                    toast('Enter manual command.');
                    return;
                }
                manualCommand.paw = this.selectedAgent.paw;
                manualCommand.executor.name = document.getElementById('manual-executors').selectedOptions[0].value;
                manualCommand.executor.platform = this.selectedAgent.platform;

                apiV2('POST', `${this.ENDPOINT}/${this.selectedOperationID}/potential-links`, manualCommand)
                    .then((res) => {
                        toast('Added manual command.', true);
                        this.getOperation();

                        // Reset
                        this.addNewRow = false;
                        this.selectedAgentIndex = null;
                    })
                    .catch((error) => toast('Error adding manual command.'));
            },

            addPotentialLink(link) {
                apiV2('POST', `${this.ENDPOINT}/${this.selectedOperationID}/potential-links`, link)
                    .then((res) => {
                        toast('Added potential link.', true);
                        this.getOperation();
                        this.addedTechniquesIDs.add(link.technique_id);
                        this.openModal = null;
                    })
                    .catch((error) => {
                        toast('Error adding potential link.');
                    });
            },

            getLink(link) {
                if (this.selectedLink === link) return;
                this.selectedLink = link;
                apiV2('GET', `${this.ENDPOINT}/${this.selectedOperationID}/links/${link.id}`)
                    .then((res) => {
                        this.getLinkResults(res.output, link);
                        if (res.facts) {
                            this.selectedLinkFacts = Array.from(new Set(res.facts)).sort((a, b) => b.score - a.score);
                        }
                        this.selectedLinkCommand = b64DecodeUnicode(res.command);
                        this.editableCommand = b64DecodeUnicode(res.command);
                    })
                    .catch((error) => {
                        this.selectedLinkResults = null;
                        this.selectedLinkFacts = null;
                        this.selectedLinkCommand = null;
                        toast('Error getting link results.', error);
                    });
            },

            getLinkResults(output, link) {
                if (output !== 'True') {
                    this.selectedLinkResults = null;
                } else {
                    apiV2('GET', `${this.ENDPOINT}/${this.selectedOperationID}/links/${link.id}/result`).then((res) => {
                        this.selectedLinkResults = b64DecodeUnicode(res.result);
                    }).catch((error) => console.error('Error getting link results.', error));
                }
            },

            updateLink(status, command = null) {
                const updateLink = {...this.selectedLink, command: b64DecodeUnicode(this.selectedLink.command)};
                if (command) {
                    updateLink.command = command;
                }
                updateLink.status = status;
                apiV2('PATCH', `${this.ENDPOINT}/${this.selectedOperationID}/links/${this.selectedLink.id}`, updateLink)
                    .then((res) => {
                        this.getOperation();
                        toast(`Updating link status to: ${this.LINK_STATUSES[status]}`, true);
                    })
                    // TODO have clearer error messaging here
                    .catch((error) => toast('Error updating link state.'));
            },

            updateOperation(field, updateValue) {
                this.selectedOperation[field] = updateValue;
                apiV2('PATCH', `${this.ENDPOINT}/${this.selectedOperationID}`, this.selectedOperation)
                    .then((res) => {
                        toast(`Updated operation ${field}`, true);
                        this.selectedOperation = res;
                    })
                    .catch((error) => {
                        // TODO have clearer error messaging here
                        toast(`Error updating operation ${field}. Operation may have already finished running.`);
                    });
            },

            downloadInfo(formatType) {
                apiV2('GET', `${this.ENDPOINT}/${this.selectedOperationID}/report`)
                    .then((res) => {
                        this.createDownloadReport(res, `${this.selectedOperation.name}_${formatType}`);
                    })
                    .catch((error) => toast('Error generating operation report.'));
            },

            downloadCSV() {
                const csv = [];
                const rows = document.querySelector('#operationsPage').querySelectorAll('table tr:not(.csv-exclude)');

                rows.forEach((row, i) => {
                    const cols = row.querySelectorAll('td:not(.csv-exclude), th:not(.csv-exclude)');
                    const rowItems = [];
                    cols.forEach(() => {
                        const link = this.selectedOperation.chain[i - 1];
                        if (col.className.includes('agentDetails')) {
                            let agentDetails = `Agent #${link.paw}`;
                            if (link.host) agentDetails += `\nHost: ${link.host}`;
                            if (link.pid) agentDetails += `\nPid: ${link.pid}`;
                            rowItems.push(`"${agentDetails}"`);
                        } else if (col.className.includes('commandDetails')) {
                            rowItems.push(`"${b64DecodeUnicode(link.command)}"`);
                        } else if (col.className.includes('outputDetails')) {
                            rowItems.push(`"${link.facts}"`);
                        } else {
                            rowItems.push(`"${col.innerText}"`);
                        }
                    });
                    csv.push(rowItems.join(','));
                });
                this.createDownloadReport(new Blob([csv.join('\n')], {type: 'text/csv'}), this.selectedOperation.name, true);
            },

            handleDownload() {
                if (this.selectedReportType === 'full-report') this.downloadInfo('full-report');
                else if (this.selectedReportType === 'event-logs') this.downloadInfo('event-logs');
                else if (this.selectedReportType === 'csv') this.downloadCSV();
            },

            //
            // OBJECT MANIPULATION
            //

            createDownloadReport(data, fileName, isCSV = false) {
                let dataURL;

                if (!isCSV) {
                    dataURL = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(data, null, 2))}`;
                    toast(`Downloading report: ${filename}`, true);
                    fileName += '.json';
                } else {
                    dataURL = window.URL.createObjectURL(data);
                }

                const elem = document.createElement('a');
                elem.setAttribute('href', dataURL);
                elem.setAttribute('download', fileName);
                elem.click();
            },

            updateAgentGroups(agents) {
                if (agents) {
                    agents.forEach((agent) => {
                        if (!this.agentGroups.includes(agent.group)) this.agentGroups.push(agent.group);
                    });
                }
            },

            validateJitter(startOperation, newValue = '') {
                if (!newValue.includes('/')) return false;
                let [jitterMin, jitterMax] = newValue.split('/');
                jitterMin = parseInt(jitterMin, 10);
                jitterMax = parseInt(jitterMax, 10);

                if (jitterMin < 0 || jitterMax < 0) {
                    toast(`Error: Jitter ${!jitterMin ? 'MIN' : 'MAX'} must be valid.`);
                    return false;
                }
                if (jitterMin >= jitterMax) {
                    toast('Error: Jitter MIN must be less than the jitter MAX.');
                    return false;
                }

                startOperation.jitter = newValue;
                return true;
            },

            filterOperations(userInput) {
                this.searchInput = userInput;
                this.filteredOperations = this.operations.filter((op) => op.name.includes(userInput)).sort((a, b) => {
                    let c = new Date(a.start);
                    let d = new Date(b.start);
                    return d - c;
                }); // Filter and sort by start time (newest -> oldest)
                this.getOperationsMenuCaretDisplay();
            },

            // TODO potential link filter by agent, technique OR tactic (API call) rather than filtering on the client-side
            filterAbilities() {
                this.filteredLinksList = this.potentialLink.agent.links.filter((link) => {
                    let match = true;
                    if (this.potentialLink.tactic) match = this.potentialLink.tactic === link.ability.tactic;
                    if (this.potentialLink.technique) match = this.potentialLink.technique === link.ability.technique_name;
                    return match;
                });
            },
        };
    }
</script>

<style>
    :scope {
        --primary-color: #8B0000;
        --dark-gray: gray;
        --light-gray: #e6e6e6;
        --decisions-color: #4fdcfc;
    }

    #operationsPage .pending-warning {
        font-variant: all-petite-caps;
        padding-top: 5px;
        color: var(--decisions-color);
    }

    #operationsPage .text-align-right {
        text-align: right !important;
    }

    #operationsPage .ellipsis-divider {
        text-align: center;
        font-size: 0.3em;
    }

    #operationsPage .ellipsis-divider i {
        color: #484747;
        padding: 0 7em;
    }

    #operationsPage span.decisionsIcon {
        font-size: x-small;
        font-weight: 500;
        font-family: sans-serif;
        position: relative;
        top: -21px;
        left: 35%;
        color: var(--decisions-color);
    }

    #operationsPage .decisionsDisplay {
        color: var(--decisions-color) !important;
    }

    #operationsPage .operation-menu-container {
        overflow-x: scroll;
        scrollbar-color: #3f3f3f #0000;
    }

    #operationsPage .operation-menu-links {
        color: white;
        margin-right: 2em;
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 5em;
        flex-flow: column wrap;
        padding: 10px;
    }

    #operationsPage .operation-menu-links .readable-time {
        width: 5em;
        text-align: center;
        color: gray;
    }

    #operationsPage .operation-menu-links i {
        font-size: 3em;
        padding-bottom: 5px;
        min-width: 35px;
    }

    #operationsPage .modal-card {
        max-height: 90vh;
    }

    #operationsPage .width-100 {
        width: 100% !important;
    }

    #operationsPage .operations-page .column {
        margin: 0;
    }

    /*MODAL FORM STYLE*/
    #operationsPage .modal-form-fields.download-buttons-container button {
        width: fit-content;
    }

    #operationsPage .modal-results ul {
        margin-left: 0;
    }

    #operationsPage .modal-results li {
        display: flex;
        justify-content: space-around;
        align-items: center;
        flex-flow: row wrap;
        list-style: none;
    }

    #operationsPage .modal-results li p {
        width: 85%;
        text-align: left;
        padding-left: 0.75rem;
    }

    #operationsPage .modal-results li button {
        width: 15%;
        display: flex;
    }

    #operationsPage .modal-results li:not(:last-child)::after {
        background-color: #262626;
        border: none;
        display: block;
        height: 2px;
        margin: 0.5rem 0;
        content: "";
    }

    #operationsPage .modal-card-foot button {
        font-size: 0.9em;
    }

    /*END MODAL FORM STYLE*/

    #operationsPage .timeline-table .modal-card code, table code {
        color: #ff8181;
        background-color: #262626;
    }

    #operationsPage .timeline-table table .highlight {
        width: fit-content !important;
    }

    #operationsPage .timeline-table {
        padding-bottom: 5em;
    }

    #operationsPage .timeline-table table tr th {
        font-weight: 400;
        font-size: 0.75rem;
        border-bottom: none;
        color: gray;
    }

    #operationsPage .timeline-table table tbody tr:hover, .timeline-table table tbody tr.selected {
        background-color: rgba(255, 255, 255, 0.1);
    }

    #operationsPage .timeline-table table tbody tr:active {
        background-color: rgba(255, 255, 255, 0.2);
    }

    #operationsPage .button:active, .button.is-active, .button:focus, .button.is-focused {
        color: inherit;
    }

    #operationsPage button.is-larger {
        font-size: 2.1rem;
    }

    #operationsPage .linkActionsColumn button[disabled] {
        background-color: transparent;
    }

    #operationsPage button.no-style {
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    #operationsPage button.no-style.reset {
        padding: 0.5em;
        width: fit-content;
        font-size: .75em;
    }

    #operationsPage button.no-style[disabled] {
        background-color: initial !important;
    }

    #operationsPage .caret-button {
        font-size: 1em;
        padding-bottom: 0;
        margin-top: -30px;
    }

    #operationsPage .scroll-more-caret {
        color: gray;
    }

    #operationsPage button.no-style:hover {
        border: none;
        color: white;
        transform: scale(1.2);
    }

    #operationsPage i sub {
        font-family: sans-serif;
    }

    #operationsPage .controls-container button {
        margin: 0 2rem;
        padding: 0;
    }

    #operationsPage .timeline-table table tbody td {
        vertical-align: middle;
        border: none;
        height: 8em;
    }

    #operationsPage .timeline-table table th.header {
        border-bottom: none;
    }

    #operationsPage .timeline-table .decideColumn {
        color: gray;
        width: 120px;
        word-break: break-word;
        font-size: 0.75rem;
        text-align: center !important;
    }

    #operationsPage .timeline-table td.decideColumn {
        padding: 0 2em;
        display: flex;
        flex-flow: column wrap;
        justify-content: center;
    }

    #operationsPage .timeline-table .infoColumn {
        width: 200px;
    }

    #operationsPage .timeline-table table tbody td.linkStatusColumn {
        padding: 0;
        vertical-align: top;
    }

    #operationsPage .timeline-table table tbody td.linkInfoColumn {
        padding-top: 3.5em;
        vertical-align: initial;
    }

    #operationsPage .timeline-table table tbody td.linkActionsColumn {
        display: flex;
        align-items: center;
        flex-flow: row-reverse;
        padding-bottom: 0;
    }

    #operationsPage .timeline-table table tbody td.commandDetails textarea {
        color: #ff8181;
        background-color: #262626;
    }

    #operationsPage .timeline-table table tbody td textarea[contenteditable] {
        width: 100%;
        height: 5em;
        margin-top: 1em;
    }

    #operationsPage .timeline-table table tbody td.commandDetails button {
        width: max-content;
        margin: 1em 0;
    }

    #operationsPage .timeline-table table tbody tr.linkEditCommandRow td:last-child {
        display: flex;
        justify-content: space-around;
        padding: 0;
        flex-flow: row;
        align-items: center;
        background-color: #2b2929;
        border-radius: 2px;
    }

    #operationsPage .timeline-table table tbody tr.linkEditCommandRow textarea {
        border-radius: 2px;
        line-height: 0.75rem;
        width: 10rem;
    }

    #operationsPage .timeline-table table tbody tr.linkEditCommandRow .linkEditControls {
        display: flex;
        flex-flow: row wrap;
        justify-content: flex-end;
        align-items: center;
    }

    #operationsPage .timeline-table table tfoot td {
        padding-top: 1em;
        border: none !important;
    }

    /*gray timeline*/
    #operationsPage span.linkStatus::before {
        width: 2px;
        height: 180px;
        background-color: white;
        /*background-color: var(--primary-color);*/
        content: "";
        display: inline-block;
        position: absolute;
        margin-left: 10px;
        margin-top: 3em;
    }

    /*circle for event*/
    #operationsPage span.linkStatus::after {
        position: relative;
        left: -5px;
        top: 50px;
        display: block;
        background: #161616;
        border-radius: 50%;
        height: 2em;
        width: 2em;
        content: "";
    }

    /*queued*/
    #operationsPage span.status-queued {
        color: #555;
    }

    #operationsPage span.status-queued::after {
        box-shadow: 0 0 0 0.2em #555;
    }

    /*success*/
    #operationsPage span.status-success {
        color: #4a9;
    }

    #operationsPage span.status-success::after {
        box-shadow: 0 0 0 0.2em #4a9;
    }

    /*failure*/
    #operationsPage span.status-failed {
        color: #c31;
    }

    #operationsPage span.status-failed::after {
        box-shadow: 0 0 0 0.2em #c31;
    }

    /*paused*/
    #operationsPage span.status-paused {
        color: #ffc500;
    }

    #operationsPage span.status-paused::after {
        box-shadow: 0 0 0 0.2em #ffc500;
    }

    /*removed*/
    #operationsPage span.status-discarded {
        color: #a05195;
    }

    #operationsPage span.status-discarded::after {
        box-shadow: 0 0 0 0.2em #a05195;
    }

    /*collected*/
    #operationsPage span.status-collect {
        color: #ffb000;
    }

    #operationsPage span.status-collect::after {
        box-shadow: 0 0 0 0.2em #ffb000;
    }

    /*untrusted*/
    #operationsPage span.status-untrusted {
        color: white;
    }

    #operationsPage span.status-untrusted::after {
        box-shadow: 0 0 0 0.2em white;
    }

    /*visible*/
    #operationsPage span.status-visible {
        color: #f012be;
    }

    #operationsPage span.status-visible::after {
        box-shadow: 0 0 0 0.2em #f012be;
    }

    /*timeout*/
    #operationsPage span.status-timeout {
        color: cornflowerblue;
    }

    #operationsPage span.status-timeout::after {
        box-shadow: 0 0 0 0.2em cornflowerblue;
    }
</style>
