<div x-data="alpineOperations()" x-init="getOperations()" xmlns="http://www.w3.org/1999/html"
     @resize.window="getOperationsMenuCaretDisplay()">
    <div>
        <div>
            <div>
                <h2>Operations</h2>
                <p>
                    Start a new operation or review previous ones here.
                </p>
            </div>
            <hr>
        </div>

        <div>
            <div x-bind:class="isOperationsControlsExpanded ? '' : 'columns'">

                <div class="is-flex-direction-column"
                     x-bind:class="isOperationsControlsExpanded ? '' : 'column is-half pb-0'">
                    <div class="columns">
                        <div x-bind:class="isOperationsControlsExpanded ? 'is-one-fifth' : ''"
                             class="column is-flex is-justify-content-space-between is-flex-direction-column">
                            <div class="is-flex is-align-items-center search-box">
                                <i class="fas fa-search"></i>
                                <input id="op-search"
                                       placeholder="Operation name"
                                       x-ref="search"
                                       x-on:keyup="filterOperations($el.value)">
                                <i class="fas fa-times"
                                   x-on:click="filterOperations(''); searchInput = ''; $refs.search.value=''"></i>
                            </div>
                            <label class="is-size-7" for="op-search">
                                <em x-text="searchInput ? ('searching: ' + searchInput) : 'search operations'"></em>
                            </label>
                        </div>
                        <div class="column pl-0 is-flex is-align-content-flex-start">
                            <button x-bind:disabled="!(searchInput && filteredOperations.length === 0)" type="button"
                                    title="quick add operation" class="button is-primary is-small"
                                    x-on:click="addOperation(true)"><i class="pr-1 fas fa-plus"></i>
                                Quick add
                            </button>
                            <button type="button" title="add operation" class="ml-2 button is-primary is-small"
                                    x-on:click="openModal = 'addOperation'"><i class="pr-1 fas fa-plus"></i>
                                Create operation
                            </button>
                        </div>
                    </div>
                    <div class="is-flex is-flex-direction-row is-align-items-center">
                        <div class="is-flex is-flex-direction-row is-justify-content-flex-start operation-menu-container">
                            <template x-for="op in filteredOperations">
                                <button class="no-style operation-menu-links"
                                        x-bind:title="op.name + ' has ' + op.chain.length + ' decisions'"
                                        :key="op.id"
                                        x-on:click="selectedOperationID = op.id; getOperation()">
                                    <i x-show="selectedOperationID !== op.id" class="far fa-folder">
                                        <span class="decisionsIcon" x-text="op.chain.length"></span></i>
                                    <i x-show="selectedOperationID === op.id" class="far fa-folder-open"></i>
                                    <span x-text="op.name"></span>
                                    <span class="readable-time" x-text="getHumanFriendlyTime(op.start)"></span>
                                </button>
                            </template>
                        </div>
                        <template x-if="showOperationsMenuCaret">
                            <div class="ml-2 scroll-more-caret">
                                <i class="fas fa-angle-right"></i>
                            </div>
                        </template>
                    </div>
                </div>


                <div x-bind:class="isOperationsControlsExpanded ? '' : 'column is-half pb-0'">
                    <template x-if="selectedOperation">
                        <div x-show="selectedOperationID">
                            <template x-if="isOperationsControlsExpanded">
                                <div class="ellipsis-divider mt-2 mb-5">
                                    <i class="fas fa-circle"></i>
                                    <i class="fas fa-circle"></i>
                                    <i class="fas fa-circle"></i>
                                </div>
                            </template>
                            <div class="columns">
                                <div class="column is-flex is-flex-direction-column is-justify-content-center">
                                    <div class="is-flex is-flex-direction-row is-justify-content-center mt-2 ml-5">
                                        <div class="mr-6">
                                            <h3 class="my-1 is-size-4" x-text="selectedOperation.name"></h3>
                                            <h2 class="is-size-6 has-text-weight-normal mb-5 mt-0">Operation</h2>
                                        </div>
                                        <div class="mr-6">
                                            <h3 class="my-1 is-size-5" x-text="selectedOperation.state"></h3>
                                            <h2 class="is-size-7 has-text-weight-normal mb-5 mt-0">Current state</h2>
                                        </div>
                                        <div class="mr-6">
                                            <h3 class="my-1 is-size-5" x-text="selectedOperation.chain.length"></h3>
                                            <h2 class="is-size-7 has-text-weight-normal mb-5 mt-0">Decisions</h2>
                                        </div>
                                    </div>
                                    <div class="controls-container is-flex is-justify-content-center is-align-items-center">
                                        <button class="button no-style is-large"
                                                x-on:click="updateOperationState('cleanup')"><i
                                                alt="stop" class="fas fa-stop"></i></button>
                                        <template x-if="selectedOperation.state ==='running'">
                                            <button class="button no-style is-larger"
                                                    x-on:click="updateOperationState('paused')"><i
                                                    alt="pause" class="fas fa-pause-circle"></i></button>
                                        </template>
                                        <template x-if="selectedOperation.state !== 'running'">
                                            <button class="button no-style is-larger"
                                                    x-on:click="updateOperationState('running')">
                                                <i alt="run" class="fas fa-play-circle"></i></button>
                                        </template>
                                        <button class="button no-style is-medium"
                                                x-on:click="updateOperationState('run_one_link')">
                                            <i alt="run one step" class="fas fa-play"><sub>1</sub></i></button>
                                    </div>

                                    <template x-if="isOperationsControlsExpanded">
                                        <div class="is-flex is-justify-content-center pt-2">
                                            <button title="download event logs"
                                                    class="mx-2 button no-style"
                                                    x-on:click="openModal = 'showDownloadMenu'"><i
                                                    class="pr-1 fas fa-arrow-down"></i>
                                            </button>
                                            <button type="button" title="delete operation"
                                                    class="mx-2 button no-style"
                                                    x-on:click="openModal = 'deleteOperationModal'"><i
                                                    class="pr-1 fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </template>
                                </div>

                                <template x-if="isOperationsControlsExpanded">
                                    <div class="column is-flex is-flex-direction-column is-flex-wrap-wrap is-align-items-flex-end">
                                        <div class="mb-4">
                                            <label x-show="false" for="operation-obfuscator" class="is-size-6">
                                                Obfuscation method:
                                            </label>
                                            <div class="is-flex is-flex-direction-row is-flex-wrap-wrap is-justify-content-center pb-2"
                                                 id="operation-obfuscator">
                                                {% for o in obfuscators %}
                                                <button x-bind:class="selectedOperation.obfuscator === `{{ o.name|e }}` ? 'selected' : ''"
                                                        class="no-style chip-select"
                                                        x-on:click="updateObfuscator(`{{ o.name|e }}`)">
                                                    {{ o.name|e }}
                                                </button>
                                                {% endfor %}
                                            </div>
                                        </div>

                                        <div class="is-flex is-flex-direction-row is-justify-content-center is-align-items-center width-100">
                                            <div class="toggleContainer">
                                                <label for="toggleAutonomous">Manual</label>
                                                <div class="toggleSwitch mx-2">
                                                    <input type="checkbox"
                                                           id="toggleAutonomous"
                                                           x-model="selectedOperation.autonomous"
                                                           x-bind:checked="Boolean(selectedOperation.autonomous) ? 'checked' : null"
                                                           x-on:change="updateOperationToggle()"/>
                                                    <span class="toggleSlider toggleSliderRound"
                                                          x-on:click="selectedOperation.autonomous = !selectedOperation.autonomous; updateOperationToggle()"
                                                          x-bind:class="Boolean(selectedOperation.autonomous) ? 'toggle-on' : 'toggle-off'">
                                                <span x-bind:class="Boolean(selectedOperation.autonomous) ? 'toggle-slider-on' : 'toggle-slider-off'"></span>
                                            </span>
                                                </div>
                                                <label for="toggleAutonomous">Autonomous</label>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>

                        </div>
                    </template>
                </div>
            </div>

            <template x-if="selectedOperation">
                <div class="width-100 is-flex is-justify-content-center">
                    <button class="button no-style caret-button"
                            type="button"
                            x-on:click="isOperationsControlsExpanded = !isOperationsControlsExpanded; getOperationsMenuCaretDisplay()">
                        <i x-show="isOperationsControlsExpanded" class="fas fa-angle-up"></i>
                        <i x-show="!isOperationsControlsExpanded" class="fas fa-angle-down"></i>
                    </button>
                </div>
            </template>

            <!--            TIMELINE-->
            <div>
                <template x-if="selectedOperation">
                    <div x-show="selectedOperationID">
                        <div class="navbar-divider mb-5 width-100"></div>
                        <div class="log-container">
                            <table class="table">
                                <thead>
                                <tr class="table-header">
                                    <th class="decideColumn">Decide / Status</th>
                                    <th title="Link Status Indicator"></th>
                                    <th class="infoColumn">Link/Ability Name</th>
                                    <th>Agent</th>
                                    <th>Link Command</th>
                                    <th>Link Output & Facts</th>
                                </tr>
                                </thead>

                                <template x-if="selectedOperation.chain.length === 0">
                                    <tbody>
                                    <tr>
                                        <td colspan="6"><em>No links––click the buttons on the right to add
                                            commands/links.</em>
                                        </td>
                                    </tr>
                                    </tbody>
                                </template>
                                <template x-for="(link, index) in selectedOperation.chain">
                                    <tbody :key="index">
                                    <tr x-bind:id="link.id"
                                        x-bind:class="selectedLink === link ? 'selected' : ''"
                                        x-on:click="selectedLink = link; getLinkResults(link.id);">
                                        <td class="decideColumn">
                                            <span x-text="getHumanFriendlyTime(link.decide)"></span>
                                            <span x-bind:class="'status-'+((link.status in linkStatuses) ? linkStatuses[link.status] : 'queued')"
                                                  x-text="(link.status in linkStatuses) ? linkStatuses[link.status] : 'queued'"></span>
                                        </td>
                                        <td class="linkStatusColumn">
                                                    <span x-bind:title="(link.status in linkStatuses) ? linkStatuses[link.status] : 'queued'"
                                                          x-bind:class="'linkStatus status-'+((link.status in linkStatuses) ? linkStatuses[link.status] : 'queued')"></span>
                                        </td>
                                        <td class="linkInfoColumn"
                                            x-text="link.ability.name + ((link.ability.cleanup) ? '(CLEANUP)' : '')"></td>

                                        <!--AGENT COLUMN-->
                                        <td x-bind:class="selectedLink === link ? '' : 'linkInfoColumn'">
                                            <p x-show="link.paw">Agent #<em x-text="link.paw"></em></p>
                                            <p x-show="selectedLink === link && link.host">Host: <em
                                                    x-text="link.host"></em></p>
                                            <p x-show="selectedLink === link && link.pid">pid: <em
                                                    x-text="link.pid"></em></p>
                                        </td>

                                        <!--COMMAND COLUMN-->
                                        <td class="outputEditCommand">
                                            <template x-if="index === 0 && !selectedLink">
                                                <em>Click on a link to show more details.</em>
                                            </template>
                                            <template
                                                    x-if="selectedLink === link && !(selectedLink?.status === -1 || selectedLink.finish || selectedLink.output)">
                                                <div class="is-flex is-align-items-flex-end is-justify-content-center is-flex-direction-column">
                                                    <label x-show="false" for="view-command">View command</label>
                                                    <textarea id="view-command"
                                                              class="code"
                                                              readonly
                                                              x-text="selectedLinkCommand"
                                                              spellcheck="false"></textarea>
                                                </div>
                                            </template>
                                            <template
                                                    x-if="selectedLink === link && (selectedLink?.status === -1 || selectedLink.finish || selectedLink.output)">
                                                <div class="is-flex is-align-items-flex-end is-justify-content-center is-flex-direction-column">
                                                    <label x-show="false" for="edit-command">Edit command</label>
                                                    <textarea id="edit-command"
                                                              class="code"
                                                              contenteditable
                                                              x-model="editableCommand"
                                                              spellcheck="false"></textarea>
                                                    <button type="button"
                                                            class="button is-primary is-small"
                                                            x-on:click="updateLinkState(selectedLink?.id, -3, editableCommand); showLinkEditCommandID = null;">
                                                        Update
                                                    </button>
                                                </div>
                                            </template>
                                        </td>

                                        <!--OUTPUT/FACTS COLUMN-->
                                        <td>
                                            <template x-if="selectedLink === link && selectedLinkOutput">
                                                <div class="mb-5">
                                                    <p class="is-size-7">Output: </p>
                                                    <code x-text="selectedLinkOutput"></code>
                                                </div>
                                            </template>
                                            <template x-if="selectedLink === link && !selectedLinkOutput">
                                                <p class="is-size-7">No output available.</p>
                                            </template>
                                            <template x-if="selectedLink === link && selectedLinkFacts?.length > 0">
                                                <div class="mb-5">
                                                    <p class="is-size-7">Facts: </p>
                                                    <template x-for="(fact, index) in selectedLinkFacts">
                                                        <code x-bind:id="index" class="highlight" x-text="fact.score + (index < selectedLinkFacts.length - 1 ? ', ' : ' ')"></code>
<!--                                                        TODO fix selectedLinkFacts length error-->
                                                    </template>
                                                </div>
                                            </template>
                                            <template x-if="selectedLink === link && selectedLinkFacts?.length < 1">
                                                <p class="is-size-7">No facts available.</p>
                                            </template>
                                        </td>
                                    </tr>
                                    </tbody>
                                </template>

                                <!--                                NEW ROW TO ADD MANUAL COMMAND-->
                                <tbody>
                                <template x-if="addNewRow">
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td>New Manual Command</td>
                                        <td>
                                            <label x-show="false" for="manual-agent">Choose an agent:</label>
                                            <select id="manual-agent" x-model="selectedAgentIndex" required>
                                                <option selected>Choose agent</option>
                                                <template
                                                        x-for="(agent, index) in selectedOperation.host_group">
                                                    <option :value="index"
                                                            x-text="agent.display_name + '-' + agent.paw"></option>
                                                </template>
                                            </select>
                                        </td>
                                        <td x-show="selectedAgentInde">
                                            <select x-model="manualCommand.executor"
                                                    id="manual-executor"
                                                    class="column executor-selector">
                                                <option>Choose executor</option>
                                                <template
                                                        x-for="(executor, index) in selectedAgentExecutors">
                                                    <option x-text="executor"
                                                            :value="selectedAgent.executors[index]"
                                                            x-bind:selected="index === 0"></option>
                                                </template>
                                            </select>
                                        </td>
                                        <td x-show="selectedAgentIndex">
                                            <label x-show="false" for="input-command">Type manual command:</label>
                                            <div class="is-flex is-align-items-flex-end is-justify-content-center is-flex-direction-column">
                                                <textarea x-model="manualCommand.command"
                                                          class="input executor-command"
                                                          id="input-command"
                                                          type="text"
                                                          spellcheck="false"
                                                          contenteditable
                                                          required></textarea>
                                                <div class="is-flex is-flex-direction-row is-align-items-flex-end">
                                                    <button type="button"
                                                            class="button is-small mr-2"
                                                            x-on:click="addNewRow = false;">
                                                        Cancel
                                                    </button>
                                                    <button type="button"
                                                            class="button is-primary is-small mt-2"
                                                            x-on:click="handleManualCommand();">
                                                        Add Command
                                                    </button>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                </tbody>

                                <!--                                ADD COMMAND/LINK BUTTONS-->
                                <tfoot>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td class="is-flex is-justify-content-flex-end mt-5">
                                        <button title="add manual command" class="button is-primary is-small ml-2"
                                                x-on:click="addNewRow = true">
                                            <i class="pr-1 fas fa-plus"></i>Manual
                                            Command
                                        </button>
                                        <button title="add potential link" class="button is-primary is-small ml-2"
                                                x-on:click="openModal = 'addLink'"><i class="pr-1 fas fa-plus"></i>Potential
                                            Link
                                        </button>
                                    </td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </template>
            </div>

        </div>

        <!--    MODALS      -->
        <template x-if="openModal">
            <div class="modal is-active">
                <div class="modal-background"></div>
                <form class="m-1">
                    <div class="modal-card">
                        <template x-if="openModal === 'addOperation'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Start New Operation</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="op-name">Operation name:</label>
                                            <div class="modal-form-fields">
                                                <input class="input" id="op-name" type="text"
                                                       x-model="startOperation.name" required>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="basic-adversary">Adversary:</label>
                                            <div class="modal-form-fields" id="basic-adversary">
                                                <select x-model="startOperation.adversary.adversary_id">
                                                    <option value="" selected>No adversary (manual)</option>
                                                    {% for adv in adversaries %}
                                                    <option x-on:click="isSelectedAdversaryRepeatable = {{ adv.has_repeatable_abilities }}"
                                                            value="{{ adv.adversary_id|e }}">
                                                        {{ adv.name|e }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="autonomous-source">Fact source:</label>
                                            <div class="modal-form-fields" id="autonomous-source">
                                                <select x-model="startOperation.source.id">
                                                    {% for s in sources %}
                                                    <option>{{ s.name|e }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="modal-form-group-header">
                                        <button type="button" class="button no-style heading pt-2"
                                                x-on:click="openModalForm.advanced = !openModalForm.advanced"
                                                x-bind:class="openModalForm.advanced ? 'expanded' : 'collapsed'">
                                            <span>Advanced</span>
                                            <span class="navbar-divider"></span>
                                        </button>
                                    </div>
                                    <div class="modal-form" x-show="openModalForm.advanced">
                                        <div>
                                            <label for="basic-groups">Group:</label>
                                            <div class="modal-form-fields"
                                                 id="basic-groups">
                                                <button type="button"
                                                        class="no-style chip-select"
                                                        x-bind:class="(startOperation.group === '') ? 'selected' : ''"
                                                        x-on:click="startOperation.group = ''">
                                                    all groups
                                                </button>
                                                <template x-for="(group, index) in agentGroups">
                                                    <button type="button"
                                                            :key="index"
                                                            class="no-style chip-select"
                                                            x-bind:class="(startOperation.group === group) ? 'selected' : ''"
                                                            x-on:click="startOperation.group = group"
                                                            x-text="group">
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="autonomous-planner">Planner:</label>
                                            <div class="modal-form-fields">
                                                <select id="autonomous-planner" x-model="startOperation.planner.id">
                                                    {% for p in planners %}
                                                    {% if p.allow_repeatable_abilities %}
                                                    <option data-allow-repeatable-abilities>
                                                        {{ p.name|e }}
                                                    </option>
                                                    {% else %}
                                                    <option x-bind:disabled="isSelectedAdversaryRepeatable ? 'true' : null">
                                                        {{ p.name|e }}
                                                    </option>
                                                    {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="stealth-obfuscator">Obfuscators:</label>
                                            <div class="modal-form-fields" id="stealth-obfuscator">
                                                {% for o in obfuscators %}
                                                <button class="no-style chip-select"
                                                        type="button"
                                                        x-bind:class="startOperation.obfuscator === `{{ o.name|e }}` ? 'selected' : ''"
                                                        x-on:click="startOperation.obfuscator = `{{ o.name|e }}`">
                                                    {{ o.name|e }}
                                                </button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div>
                                            <label for="autonomous-autonomous">Autonomous:</label>
                                            <div class="modal-form-fields" id="autonomous-autonomous">
                                                <input type="radio" id="run-autonomously"
                                                       x-model="startOperation.autonomous" value="1" checked>
                                                <label for="run-autonomously">Run autonomously</label>
                                                <input type="radio" id="manual-approval"
                                                       x-model="startOperation.autonomous" value="0">
                                                <label for="manual-approval">Require manual approval</label>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="autonomous-use_learning_parsers">Parser:</label>
                                            <div class="modal-form-fields" id="autonomous-use_learning_parsers">
                                                <input type="radio" id="parsers-default"
                                                       x-model="startOperation.use_learning_parsers" value="1" checked>
                                                <label for="parsers-default">Use default parsers</label>
                                                <input type="radio" id="parsers-no_default"
                                                       x-model="startOperation.use_learning_parsers" value="0">
                                                <label for="parsers-no_default">Do not use default parsers</label>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="basic-keep">Keep:</label>
                                            <div class="modal-form-fields" id="basic-keep">
                                                <input type="radio" id="keep-open"
                                                       x-model="startOperation.auto_close"
                                                       value="0" checked>
                                                <label for="keep-open">Keep open forever</label>
                                                <input type="radio" id="auto-close"
                                                       x-model="startOperation.auto_close"
                                                       value="1">
                                                <label for="auto-close">Auto close operation</label>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="basic-run">Run State:</label>

                                            <div class="modal-form-fields" id="basic-run">
                                                <input type="radio" x-model="startOperation.state"
                                                       id="run-immediately"
                                                       value="running" checked>
                                                <label for="run-immediately">Run immediately</label>
                                                <input type="radio" x-model="startOperation.state"
                                                       id="pause-on-start"
                                                       value="paused">
                                                <label for="pause-on-start">Pause on start</label>
                                            </div>
                                        </div>


                                        <div>
                                            <label for="autonomous-cleanup_timeout">Cleanup Timeout (sec):</label>
                                            <div class="modal-form-fields">
                                                <input id="autonomous-cleanup_timeout" class="input"
                                                       x-model="startOperation.timeout" type="number"
                                                       placeholder="30" value="30" min="0" max="300"
                                                       x-on:change.once="toast('The number of seconds Caldera will wait per cleanup action to complete before continuing.', true)">
                                                <button type="button" class="button is-primary no-style reset"
                                                        title="reset to default"
                                                        x-on:click="startOperation.timeout = 30;">
                                                    Reset
                                                </button>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="stealth-jitter">Jitter (sec/sec):</label>
                                            <div class="modal-form-fields" id="stealth-jitter">
                                                <input class="input"
                                                       x-on:change.debounce.500ms="validateJitter(jitterMin+'/'+jitterMax)"
                                                       x-model="jitterMin"
                                                       id="stealth-jitterMin"
                                                       type="number"
                                                       required
                                                       pattern="[0-9]*"
                                                       placeholder="4"/>
                                                <label for="stealth-jitterMin" for="stealth-jitterMax">min</label>
                                                <span>/</span>
                                                <input class="input"
                                                       x-on:change.debounce.500ms="validateJitter(jitterMin+'/'+jitterMax)"
                                                       x-model="jitterMax"
                                                       id="stealth-jitterMax"
                                                       type="number"
                                                       required
                                                       pattern="[0-9]*"
                                                       placeholder="8"/>
                                                <label for="stealth-jitterMax">max</label>
                                                <button type="button" class="button is-primary no-style reset"
                                                        title="reset to default"
                                                        x-on:click="jitterMin = 4; jitterMax = 8;">
                                                    Reset
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="stealth-queue">Visibility:</label>
                                            <div class="modal-form-fields">
                                                <input x-model="startOperation.visibility"
                                                       id="stealth-queue"
                                                       type="range" value="50" min="1" max="100"
                                                       x-on:change.once="toast('The higher the visibility number, the more risk you will take with your operation getting noticed by the defense.', true)">
                                                <span x-text="startOperation.visibility"></span>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'addLink'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Add New Potential Link</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="link-agent">Agent:</label>
                                            <div class="modal-form-fields">
                                                <select id="link-agent"
                                                        x-model="selectedAgentIndex"
                                                        x-on:change="getAgentLinks()">
                                                    <option default value="">Choose an agent...</option>
                                                    <template x-for="(agent, index) in selectedOperation.host_group">
                                                        <option :value="index"
                                                                x-text="agent.display_name + '-' + agent.paw"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="link-tactic">Tactic:</label>
                                            <div class="modal-form-fields">
                                                <select id="link-tactic"
                                                        x-model="potentialLink.tactic"
                                                        x-on:change="filterAbilities()">
                                                    <option default value="">Choose a tactic...</option>
                                                    <template x-for="tactic in tacticFiltersList">
                                                        <option x-text="tactic"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="link-technique">Technique:</label>
                                            <div class="modal-form-fields">
                                                <select id="link-technique"
                                                        x-model="potentialLink.technique"
                                                        x-on:change="filterAbilities()">
                                                    <option default>Choose a technique...</option>
                                                    <template x-for="technique in techniqueFiltersList">
                                                        <option x-text="technique"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-results">
                                        <div class="navbar-divider"></div>
                                        <p class="is-flex is-justify-content-flex-end is-size-7"
                                           x-text="filteredLinksList.length + ' potential link' + ((filteredLinksList.length === 1) ? '' : 's')"></p>
                                        <template x-if="filteredLinksList">
                                            <ul>
                                                <template x-for="link in filteredLinksList">
                                                    <li>
                                                        <p x-text="link.ability.name"></p>
                                                        <button type="button"
                                                                class="button is-primary is-small"
                                                                x-on:click="addLink(link)">
                                                            Add Link
                                                        </button>
                                                    </li>
                                                </template>
                                            </ul>
                                        </template>
                                        <template x-if="!filteredLinksList"><p>Building potential links...</p>
                                        </template>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'showDownloadMenu'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Download</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="agent-output-field">Agent output:</label>
                                            <div class="modal-form-fields" id="agent-output-field">
                                                <input id="agent-output" type="checkbox"
                                                       class="mr-1"
                                                       x-model="isAgentOutputSelected">
                                                <label for="agent-output">include</label>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="report-type">Report type:</label>
                                            <div class="modal-form-fields download-buttons-container" id="report-type">
                                                <button title="download full report"
                                                        class="button is-primary is-small ml-2"
                                                        x-on:click="downloadInfo('full-report')"><i
                                                        class="pr-1 fas fa-arrow-down"></i>
                                                    Full report
                                                </button>
                                                <button title="download event logs"
                                                        class="button is-primary is-small ml-2"
                                                        x-on:click="downloadInfo('event-logs')"><i
                                                        class="pr-1 fas fa-arrow-down"></i>
                                                    Event logs
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'deleteOperationModal'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Delete operation?</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <p>Are you sure you want to delete the operation <em
                                                    x-text="selectedOperation.name"></em>?</p>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <footer class="modal-card-foot is-flex is-justify-content-space-between is-align-items-center width-100">
                            <template x-if="openModal === 'addLink' || openModal === 'showDownloadMenu'">
                                <button class="button ml-2 is-primary width-100" x-on:click="openModal = null">
                                    Close
                                </button>
                            </template>
                            <template x-if="!(openModal === 'addLink' || openModal === 'showDownloadMenu')">
                                <button class="button ml-2" x-on:click="openModal = null">
                                    Cancel
                                </button>
                            </template>
                            <template x-if="openModal === 'deleteOperationModal'">
                                <button class="button is-primary"
                                        x-on:click="deleteOperation(); openModal = null;">
                                    Yes
                                </button>
                            </template>
                            <!--                            TODO bug with pressing Enter in create new operation form (it should start operation instead)-->
                            <template x-if="openModal === 'addOperation'">
                                <button type="button" class="button is-primary" x-on:click="addOperation(false)"
                                        x-text="schedule ? 'Schedule' : 'Start'"></button>
                            </template>
                        </footer>
                    </div>
                </form>
            </div>
        </template>
    </div>
</div>

<script>
    //
    // HELPERS
    //
    const endpoint = '/api/v2/operations';
    const executorShells = {
        psh: 'PS >',
        cmd: '>',
        sh: '$'
    };
    const linkStatuses = {
        '0': 'success',
        '-1': 'paused',
        '1': 'failure',
        '-2': 'remove',
        '-3': 'collect',
        '-4': 'untrusted',
        '-5': 'visible',
        '124': 'timeout'
    };
    const emptyOperationsObject = {
        // TODO ID and objective field? timeout?
        // id: "",
        name: "",
        group: "",
        adversary: {"adversary_id": ""},
        auto_close: 0,
        state: "running",
        autonomous: 1,
        planner: {"id": "atomic"},
        // objective: {"id": ""},
        source: {"id": "basic"},
        use_learning_parsers: 1,
        // timeout: "30",
        obfuscator: "plain-text",
        jitter: "4/8",
        visibility: "50",
    }

    // https://stackoverflow.com/questions/7641791/javascript-library-for-human-friendly-relative-date-formatting
    function getHumanFriendlyTime(date) {
        // i.e. format 2021-08-03 19:37:08
        if (!date) return '';
        let split = date.split('-');

        let hMonth = Number(split[1]) - 1;
        let hDate = Number(split[2].split(' ')[0]);
        let hTime = split[2].split(' ')[1].split(':');

        const givenDate = new Date(split[0], hMonth, hDate, hTime[0], hTime[1], hTime[2]);
        // Make a fuzzy time
        let delta = Math.round((new Date - givenDate) / 1000);

        let minute = 60,
            hour = minute * 60,
            day = hour * 24;

        let fuzzy;

        if (delta < 30) {
            fuzzy = 'just now';
        } else if (delta < minute) {
            fuzzy = delta + ' seconds ago';
        } else if (delta < 2 * minute) {
            fuzzy = 'a minute ago'
        } else if (delta < hour) {
            fuzzy = Math.floor(delta / minute) + ' min ago';
        } else if (Math.floor(delta / hour) === 1) {
            fuzzy = '1 hr ago'
        } else if (delta < day) {
            fuzzy = Math.floor(delta / hour) + ' hrs ago';
        } else if (delta < day * 2) {
            fuzzy = 'yesterday';
        } else {
            switch (hMonth) {
                case 0:
                    hMonth = 'Jan';
                    break;
                case 1:
                    hMonth = 'Feb';
                    break;
                case 2:
                    hMonth = 'Mar';
                    break;
                case 3:
                    hMonth = 'Apr';
                    break;
                case 4:
                    hMonth = 'May';
                    break;
                case 5:
                    hMonth = 'Jun';
                    break;
                case 6:
                    hMonth = 'Jul';
                    break;
                case 7:
                    hMonth = 'Aug';
                    break;
                case 8:
                    hMonth = 'Sep';
                    break;
                case 9:
                    hMonth = 'Oct';
                    break;
                case 10:
                    hMonth = 'Nov';
                    break;
                case 11:
                    hMonth = 'Dec';
                    break;
                default:
                    hMonth = '';
                    break;
            }
            fuzzy = hMonth + ' ' + hDate + ' ' + hTime.join(':');
        }
        return fuzzy;
    }

    //
    // OPERATIONS
    //

    function alpineOperations() {
        return {
            agentGroups: `{{ groups | tojson }}`.toString().replace(/["\[\]]/g, '').split(','),
            selectedOperationID: null,
            selectedOperation: null,
            selectedAgentIndex: null,
            isSelectedAdversaryRepeatable: false,
            selectedLink: null,
            selectedLinkOutput: null,
            selectedLinkFacts: null,
            selectedLinkCommand: null,
            isAgentOutputSelected: false,
            openModal: null,
            openModalForm: {
                'advanced': false
            },
            operations: [],
            filteredOperations: [],
            searchInput: '',
            startOperation: emptyOperationsObject,
            jitterMin: 4,
            jitterMax: 8,
            manualCommand: {
                index: "manual_command",
                agent: "",
                operation: "",
                executor: "",
                command: ""
            },
            potentialLink: {
                agent: "",
                tactic: "",
                technique: "",
            },
            tacticFiltersList: [],
            techniqueFiltersList: [],
            filteredLinksList: [],
            schedule: "",
            showLinkEditCommandID: null,
            editableCommand: null,
            isOperationsControlsExpanded: true,
            showOperationsMenuCaret: true,
            addNewRow: false,

            get selectedAgent() {
                return this.selectedOperation?.host_group[this.selectedAgentIndex];
            },

            get selectedAgentExecutors() {
                if (this.selectedAgent) return this.selectedAgent.executors.map(e => executorShells[e]);
                else return [];
            },

            getOperationsMenuCaretDisplay() {
                const el = document.querySelector('.operation-menu-container');
                setTimeout(() => {
                    this.showOperationsMenuCaret = el.scrollWidth > el.offsetWidth
                }, 1); // timeout is to wait for UI changes to get accurate width calcs
            },

            getAgentLinks() {
                this.potentialLink.agent = this.selectedAgent;
                this.tacticFiltersList = [];
                this.techniqueFiltersList = [];
                this.potentialLink.agent.links.forEach((link) => {
                    this.tacticFiltersList.push(link.ability.tactic);
                    this.techniqueFiltersList.push(link.ability.technique_name);
                });
                this.tacticFiltersList = sortAlphabetically(this.tacticFiltersList);
                this.techniqueFiltersList = sortAlphabetically(this.techniqueFiltersList);
                this.filteredLinksList = this.potentialLink.agent.links;
            },

            //
            // API CALLS
            //

            getOperations() {
                apiV2('GET', endpoint).then((res) => {
                    this.operations = res;
                    this.filterOperations(this.searchInput);
                }).catch((error) => {
                    toast('Error getting operations');
                });
            },

            getOperation() {
                if (this.selectedOperationID) {
                    apiV2('GET', endpoint + '/' + this.selectedOperationID).then((res) => {
                        this.selectedOperation = res;
                        // toast('Go to the GameBoard plugin to see if the blue team can detect your activities.', true);
                    }).catch((error) => {
                        toast('Error getting operation');
                    });
                } else {
                    toast('Select a valid operation to view.');
                }
            },

            addOperation(isQuickAdd = false) {
                if (isQuickAdd) this.startOperation.name = this.searchInput;
                if (!this.validateJitter(this.startOperation.jitter)) return;
                if (!this.startOperation.name) {
                    toast('Error: Operation name field is empty.');
                } else {
                    this.startOperation.autonomous = Number(this.startOperation.autonomous);
                    this.startOperation.use_learning_parsers = parseInt(this.startOperation.use_learning_parsers) === 1;
                    this.startOperation.auto_close = parseInt(this.startOperation.auto_close) === 1;

                    apiV2('POST', endpoint, this.startOperation)
                        .then((res) => {
                            toast('Started operation ' + this.startOperation.name + "!", true);
                            this.resetOperation();
                            this.getOperations();
                            this.selectedOperationID = res.id;
                            this.getOperation();
                            this.openModal = null;
                            toast('Notice that you can pause or stop the operation at any time. Toggle into manual mode if you want full control or click potential links to add TTPs to the operation.', true);
                        }).catch((error) => {
                        toast('Error adding operation');
                    });
                }
            },

            deleteOperation() {
                apiV2('DELETE', endpoint + '/' + this.selectedOperationID)
                    .then(() => {
                        this.getOperations();
                        this.selectedOperation = null;
                        this.selectedOperationID = null;
                        toast('Deleted operation.', true);
                    })
                    .catch((error) => {
                        toast('Error deleting operation.');
                    })
            },

            getAgents() {
                apiV2('GET', 'api/v2/agents')
                    .then((res) => {
                        this.updateAgentGroups(res);
                    })
                    .catch((error) => {
                        toast('Error getting agents.');
                    });
            },

            getLinkResults(linkID) {
                apiV2('GET', endpoint + `/${this.selectedOperationID}/links/${linkID}`)
                    .then((res) => {
                        this.selectedLinkOutput = res.output;
                        if (res.facts) {
                            this.selectedLinkFacts = Array.from(new Set(res.facts)).sort((a, b) => b.score - a.score)
                        }
                        this.selectedLinkCommand = b64DecodeUnicode(res.command);
                        this.editableCommand = b64DecodeUnicode(res.command);
                    })
                    .catch((error) => {
                        this.selectedLinkOutput = null;
                        this.selectedLinkFacts = null;
                        this.selectedLinkCommand = null;
                        toast('Error getting link results.');
                    });
            },

            handleManualCommand() {
                if (!this.manualCommand.command) {
                    toast('Enter manual command.');
                    this.addNewRow = false;
                    return;
                }
                this.manualCommand.agent = this.selectedAgent.paw;
                this.manualCommand.operation = this.selectedOperationID;
                this.manualCommand.executor = document.getElementById('manual-executor').selectedOptions[0].value;
                restRequest('PUT', this.manualCommand, (data) => {
                    data = JSON.parse(data);
                    this.openModal = null;
                    if (data['error']) toast('Error: ' + data['error']);
                    else {
                        toast('Added manual command.', true);
                        this.getOperation();
                        this.resetObject(this.manualCommand);
                        this.selectedAgentIndex = null;
                    }
                })
            },

            addLink(link) {
                restRequest('PUT', {...link, index: "link"}, () => {
                    this.getOperations();
                    this.getAgents();
                    this.openModal = null;
                });
            },

            updateOperationState(newState) {
                toast('Changing operation state to: ' + newState, true);
                restRequest('POST', {
                    'index': 'operation',
                    'op_id': this.selectedOperationID,
                    'state': newState
                }, () => this.getOperation());
            },

            updateOperationToggle() {
                restRequest('POST', {
                    'index': 'operation',
                    'op_id': this.selectedOperationID,
                    'autonomous': 'toggleMe'
                });
            },

            updateObfuscator(newObfuscator) {
                this.selectedOperation.obfuscator = newObfuscator;
                restRequest('POST', {
                    'index': 'operation',
                    'op_id': this.selectedOperationID,
                    'obfuscator': this.selectedOperation.obfuscator
                });
            },

            updateLinkState(linkID, status, command = null) {
                const data = {
                    'index': 'chain',
                    'link_id': linkID,
                    'status': status
                };
                if (command) {
                    data['command'] = command;
                }
                restRequest('POST', data, (data) => {
                        if (data['error']) {
                            toast('Error: ' + data['error']);
                            return;
                        }
                        this.getOperation();
                        toast('Updating link status to: ' + linkStatuses[status], true);
                    }
                );
            },

            downloadInfo(formatType) {
                if (!this.selectedOperationID) {
                    toast('Select a valid operation to download.');
                } else {
                    restRequest('POST', {
                        'index': 'operation_report',
                        'op_id': this.selectedOperationID,
                        'agent_output': Number(this.isAgentOutputSelected),
                        'format': formatType
                    }, (data) => {
                        data = JSON.parse(data);
                        this.createDownloadReport(data, this.selectedOperation.name + '_' + formatType);
                    })
                }
            },

            //
            // OBJECT MANIPULATION
            //

            createDownloadReport(data, fileName) {
                const dataURL = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                toast('Downloading report: ' + fileName, true);
                const elem = document.createElement('a')
                elem.setAttribute('href', dataURL);
                elem.setAttribute('download', fileName + '.json');
                elem.click();
            },

            resetOperation() {
                this.startOperation = emptyOperationsObject;
            },

            resetObject(obj = {}) {
                for (const field in obj) {
                    if (field !== 'index') this.startOperation[field] = "";
                }
            },

            updateAgentGroups(agents) {
                if (agents) {
                    agents.forEach((agent) => {
                        if (!this.agentGroups.includes(agent.group)) this.agentGroups.push(agent.group);
                    })
                }
            },

            validateJitter(newValue = "") {
                if (!newValue.includes('/')) return false;
                let [jitterMin, jitterMax] = newValue.split("/");
                jitterMin = parseInt(jitterMin);
                jitterMax = parseInt(jitterMax);

                if (jitterMin < 0 || jitterMax < 0) {
                    toast('Error: Jitter ' + (!jitterMin ? 'MIN' : 'MAX') + ' must be valid.');
                    return false;
                }
                if (jitterMin >= jitterMax) {
                    toast('Error: Jitter MIN must be less than the jitter MAX.');
                    return false;
                }

                this.startOperation.jitter = newValue;
                return true;
            },

            filterOperations(userInput) {
                this.searchInput = userInput;
                this.filteredOperations = this.operations.filter((op) => op.name.includes(userInput)).sort((a, b) => {
                    let c = new Date(a.start);
                    let d = new Date(b.start);
                    return d - c;
                }); // Filter and sort by start time (newest -> oldest)
                this.getOperationsMenuCaretDisplay();
            },

            filterAbilities() {
                this.filteredLinksList = this.potentialLink.agent.links.filter((link) => {
                    let match = true;
                    if (this.potentialLink.tactic) match = this.potentialLink.tactic === link.ability.tactic;
                    if (this.potentialLink.technique) match = this.potentialLink.technique === link.ability.technique_name;
                    return match;
                })
            },
        }
    }
</script>

<style>
    :scope {
        --primary-color: #8B0000;
        --dark-gray: gray;
        --light-gray: #e6e6e6;
    }

    .ellipsis-divider {
        text-align: center;
        font-size: 0.3em;
    }

    .ellipsis-divider i {
        color: #484747;
        padding: 0 7em;
    }

    .search-box i {
        background-color: #e6e6e6;
        color: gray;
        height: 30px;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .search-box i:first-child {
        border-radius: 2px 0 0 2px;
    }

    .search-box i:last-child {
        border-radius: 0 2px 2px 0;
    }

    .search-box input {
        height: 30px;
        padding: 5px;
        border: none;
        width: 100%;
    }

    span.decisionsIcon {
        font-size: x-small;
        font-weight: 500;
        font-family: sans-serif;
        margin-left: -22px !important;
        position: relative;
        top: -8px;
    }

    .operation-menu-container {
        overflow-x: scroll;
        padding-bottom: 20px;
    }

    .operation-menu-links {
        color: white;
        margin-right: 2em;
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 5em;
        flex-flow: column wrap;
    }

    .operation-menu-links .readable-time {
        width: 3.9em;
        text-align: center;
        color: gray;
    }

    .operation-menu-links i {
        font-size: 3em;
        padding-bottom: 5px;
        min-width: 35px;
    }

    .modal-card {
        max-height: 90vh;
        overflow-y: scroll;
    }

    .width-100 {
        width: 100% !important;
    }

    .column {
        margin: 0;
    }

    /*MODAL FORM STYLE*/
    .modal-form > div {
        width: 100%;
        display: flex;
        flex-flow: row wrap;
        justify-content: center;
    }

    .modal-form > div > label {
        width: 30%;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        font-size: 0.75rem;
    }

    .modal-form-group-header {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-form-group-header button {
        width: 100%;
        padding-left: 0;
        padding-right: 0;
        text-align: left;
    }

    .modal-form-group-header button.expanded span:first-child::after {
        margin-left: 0.2rem;
        content: "▼";
    }

    .modal-form-group-header button.collapsed span:first-child::after {
        margin-left: 0.2rem;
        content: "►";
    }

    .modal-form-group-header button:hover {
        transform: none !important;
    }

    .modal-form-fields {
        width: 70%;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        flex-flow: row wrap;
    }

    .modal-form-fields input[type=number] {
        width: 75px;
    }

    .modal-form-fields input, .modal-form-fields select {
        margin: 0.75rem;
    }

    .modal-form-fields-columns {
        display: flex;
        flex-flow: row wrap;
        justify-content: space-between;
        align-items: center;
        margin-left: 0.75rem;
        width: 100%;
    }

    .modal-form-fields-columns .executor-selector {
        width: 10% !important;
        flex: none !important;
    }

    .modal-form-fields-columns .executor-command {
        width: 90%;
    }

    .modal-form-fields label {
        margin-right: 1rem;
        font-size: 0.75rem;
    }

    .modal-form-fields.download-buttons-container button {
        width: fit-content;
    }

    .modal-results ul {
        margin-left: 0;
    }

    .modal-results li {
        display: flex;
        justify-content: space-around;
        align-items: center;
        flex-flow: row wrap;
        list-style: none;
    }

    .modal-results li p {
        width: 85%;
        text-align: left;
        padding-left: 0.75rem;
    }

    .modal-results li button {
        width: 15%;
        display: flex;
    }

    .modal-results li:not(:last-child)::after {
        background-color: #262626;
        border: none;
        display: block;
        height: 2px;
        margin: 0.5rem 0;
        content: "";
    }

    .modal-card-foot button {
        font-size: 0.9em;
    }

    /*END MODAL FORM STYLE*/

    .modal-card code, table code {
        color: #ff8181;
        background-color: #262626;
    }

    table .highlight {
        width: fit-content !important;
    }

    /*TOGGLE STYLE*/
    /* toggle buttons */
    .toggleContainer {
        display: flex;
        align-items: center;
    }

    .toggleContainer label {
        font-size: 0.75em;
    }

    .toggleSwitch {
        position: relative;
        display: inline-block;
        width: 65px;
        height: 34px;
    }

    .toggleSwitch input {
        display: none;
    }

    .toggleSlider {
        border: 2px solid white;
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 34px;
    }

    .toggleSlider::before {
        position: absolute;
        content: "";
        height: 24px;
        width: 24px;
        bottom: 4px;
        transition: all 0.3s ease;
        left: 3px;
        top: 3px;
    }

    .toggle-off {
        background-color: initial;
    }

    .toggle-on {
        background-color: #339c3f;
    }

    .toggle-slider-on,
    .toggle-slider-off {
        color: white;
        position: absolute;
        transform: translate(-50%, -50%);
        top: 50%;
        left: 50%;
        font-size: 10px;
        font-family: Verdana, sans-serif;
    }

    .toggle-on.toggleSlider.toggleSlider::before {
        background-color: white;
        transform: translatex(30px);
    }

    .toggle-off.toggleSlider.toggleSlider::before {
        background-color: white;
        transform: translatex(0px);
    }

    .toggleSlider.toggleSliderRound::before {
        border-radius: 50%;
    }

    /*END TOGGLE*/


    .log-container {
        /*background-color: black;*/
        border-radius: 5px;
        margin-top: 1rem;
        padding: 2rem 1.3rem 4rem;
        border-collapse: collapse;
    }

    .log-container table {
        /*background-color: black;*/
        background-color: inherit;
    }

    .log-container table tr th {
        font-weight: 400;
        font-size: 0.75rem;
        border-bottom: none;
        color: gray;
    }

    /*TODO hover over entire row should highlight, even if cell is empty*/
    .log-container table tbody tr:hover, .log-container table tbody tr.selected {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .log-container table tbody tr:active {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .button:active, .button.is-active, .button:focus, .button.is-focused {
        color: inherit;
    }

    button.is-larger {
        font-size: 2.1rem;
    }

    .linkActionsColumn button[disabled] {
        background-color: transparent;
    }

    button.no-style {
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    button.no-style.reset {
        padding: 0.5em;
        width: fit-content;
        font-size: .75em;
    }

    button.no-style[disabled] {
        background-color: initial !important;
    }

    .caret-button {
        font-size: 1.4em;
        padding-top: 1em;
        padding-bottom: 0;
    }

    .scroll-more-caret {
        color: gray;
    }

    label[for="stealth-jitterMin"], label[for="stealth-jitterMax"] {
        position: relative;
        margin-top: -40px;
        margin-left: -40px;
        color: #a0a0a0;
    }

    .modal-form-fields button.chip-select {
        width: fit-content;
        margin: 0.75em 0 0 0.75em;
    }

    button.chip-select {
        border: 2px solid var(--primary-color);
        border-radius: 24px;
        color: white;
        padding: 5px 12px;
        cursor: pointer;
        margin: 0.75em 0.75em 0 0;
    }

    button.chip-select:hover {
        background-color: var(--primary-color);
        transform: none !important;
    }

    button.chip-select.selected {
        background-color: var(--primary-color);
    }

    button.no-style:hover {
        border: none;
        color: white;
        transform: scale(1.2);
    }

    i sub {
        font-family: sans-serif;
    }

    .controls-container button {
        margin: 0 2rem;
        padding: 0;
    }

    .log-container table tbody td {
        vertical-align: middle;
        border: none;
        height: 8em;
    }

    .log-container table th.header {
        border-bottom: none;
    }

    .log-container .decideColumn {
        color: gray;
        width: 120px;
        word-break: break-word;
        font-size: 0.75rem;
        text-align: center !important;
    }

    .log-container td.decideColumn {
        padding: 0 2em;
        display: flex;
        flex-flow: column wrap;
        justify-content: center;
    }

    .log-container .infoColumn {
        width: 200px;
    }

    table tbody td.linkStatusColumn {
        padding: 0;
        vertical-align: top;
    }

    table tbody td.linkInfoColumn {
        padding-top: 3.5em;
        vertical-align: initial;
    }

    table tbody td.linkActionsColumn {
        display: flex;
        align-items: center;
        flex-flow: row-reverse;
        padding-bottom: 0;
    }

    table tbody td.outputEditCommand textarea {
        color: #ff8181;
        background-color: #262626;
    }

    table tbody td textarea[contenteditable] {
        width: 100%;
        height: 5em;
        margin-top: 1em;
    }

    table tbody td.outputEditCommand button {
        width: max-content;
        margin: 1em 0;
    }

    table tbody tr.linkEditCommandRow td:last-child {
        display: flex;
        justify-content: space-around;
        padding: 0;
        flex-flow: row;
        align-items: center;
        background-color: #2b2929;
        border-radius: 2px;
    }

    table tbody tr.linkEditCommandRow textarea {
        border-radius: 2px;
        line-height: 0.75rem;
        width: 10rem;
    }

    table tbody tr.linkEditCommandRow .linkEditControls {
        display: flex;
        flex-flow: row wrap;
        justify-content: flex-end;
        align-items: center;
    }

    table tfoot td {
        padding-top: 1em;
        border: none !important;
    }

    /*gray timeline*/
    span.linkStatus::before {
        width: 2px;
        height: 180px;
        background-color: white;
        /*background-color: var(--primary-color);*/
        content: "";
        display: inline-block;
        position: absolute;
        margin-left: 10px;
        margin-top: 3em;
    }

    /*circle for event*/
    span.linkStatus::after {
        position: relative;
        left: -5px;
        top: 50px;
        display: block;
        background: #161616;
        border-radius: 50%;
        height: 2em;
        width: 2em;
        content: "";
    }

    /*queued*/
    span.status-queued {
        color: #555;
    }

    span.status-queued::after {
        box-shadow: 0 0 0 0.2em #555;
    }

    /*success*/
    span.status-success {
        color: #4a9;
    }

    span.status-success::after {
        box-shadow: 0 0 0 0.2em #4a9;
    }

    /*failure*/
    span.status-failure {
        color: #c31;
    }

    span.status-failure::after {
        box-shadow: 0 0 0 0.2em #c31;
    }

    /*paused*/
    span.status-paused {
        color: #ffc500;
    }

    span.status-paused::after {
        box-shadow: 0 0 0 0.2em #ffc500;
    }

    /*removed*/
    span.status-remove {
        color: #a05195;
    }

    span.status-remove::after {
        box-shadow: 0 0 0 0.2em #a05195;
    }

    /*collected*/
    span.status-collect {
        color: #ffb000;
    }

    span.status-collect::after {
        box-shadow: 0 0 0 0.2em #ffb000;
    }

    /*untrusted*/
    span.status-untrusted {
        color: white;
    }

    span.status-untrusted::after {
        box-shadow: 0 0 0 0.2em white;
    }

    /*visible*/
    span.status-visible {
        color: #f012be;
    }

    span.status-visible::after {
        box-shadow: 0 0 0 0.2em #f012be;
    }

    /*timeout*/
    span.status-timeout {
        color: cornflowerblue;
    }

    span.status-timeout::after {
        box-shadow: 0 0 0 0.2em cornflowerblue;
    }
</style>
